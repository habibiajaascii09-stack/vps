name: Ephemeral Pterodactyl Panel (Minimal, Tailscale) - 6h

on:
  workflow_dispatch:
    inputs:
      admin_email:
        description: 'Admin email untuk panel'
        required: true
        default: 'ashifaja123@gmail.com'
      panel_domain:
        description: 'Domain untuk panel (nginx server_name)'
        required: true
        default: 'panel.panelasip.my.id'

jobs:
  pterodactyl-minimal:
    runs-on: ubuntu-22.04
    timeout-minutes: 360

    env:
      PANEL_PATH: /var/www/pterodactyl

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Install Tailscale and bring up (SSH)
      run: |
        set -e
        curl -fsSL https://tailscale.com/install.sh | sh
        # bring up tailscale; ensure secret TAILSCALE_AUTHKEY is set in repo secrets
        sudo tailscale up --authkey "${{ secrets.TAILSCALE_AUTHKEY }}" --ssh || true
        tailscale ip -4 > /tmp/TS_IP || true
        echo "TAILSCALE ready"

    - name: Read Tailscale IP
      id: tsip
      run: |
        TS_IP=$(cat /tmp/TS_IP 2>/dev/null | head -n1 || true)
        if [ -z "$TS_IP" ]; then
          TS_IP=$(tailscale ip -4 2>/dev/null | head -n1 || true)
        fi
        echo "ts_ip=$TS_IP" >> $GITHUB_OUTPUT

    - name: Install SSH server & set SSH password (printed + saved)
      id: sshinfo
      run: |
        sudo apt-get update -y
        sudo apt-get install -y openssh-server openssh-client
        sudo systemctl enable --now ssh

        SSH_PASS=$(openssl rand -base64 12)
        echo "runner:$SSH_PASS" | sudo chpasswd

        echo "SSH_USER=runner" >> $GITHUB_OUTPUT
        echo "SSH_PASS=$SSH_PASS" >> $GITHUB_OUTPUT

        mkdir -p /home/runner
        echo "SSH_USER=runner" > /home/runner/creds.txt
        echo "SSH_PASS=$SSH_PASS" >> /home/runner/creds.txt
        sudo chown runner:runner /home/runner/creds.txt

    - name: Install core packages (MariaDB, nginx, redis, utilities)
      run: |
        set -e
        sudo apt-get update -y
        sudo apt-get install -y software-properties-common curl unzip tar ufw git ca-certificates
        sudo apt-get install -y mariadb-server redis-server nginx
        sudo systemctl enable --now mariadb redis-server nginx

    - name: Install PHP 8.2 & extensions
      run: |
        set -e
        sudo add-apt-repository ppa:ondrej/php -y
        sudo apt-get update -y
        sudo apt-get install -y php8.2 php8.2-cli php8.2-fpm php8.2-mysql php8.2-gd \
          php8.2-mbstring php8.2-tokenizer php8.2-bcmath php8.2-xml php8.2-curl php8.2-zip
        sudo systemctl enable --now php8.2-fpm

    - name: Create DB and user for Pterodactyl
      id: dbinfo
      run: |
        set -e
        DB_PASS=$(openssl rand -base64 16)
        sudo mysql <<EOF
CREATE DATABASE IF NOT EXISTS pterodactyl;
CREATE USER IF NOT EXISTS 'ptero'@'127.0.0.1' IDENTIFIED BY '$DB_PASS';
GRANT ALL PRIVILEGES ON pterodactyl.* TO 'ptero'@'127.0.0.1';
FLUSH PRIVILEGES;
EOF
        echo "DB_PASS=$DB_PASS" >> $GITHUB_OUTPUT
        # append to creds file
        echo "DB_USER=ptero" >> /home/runner/creds.txt
        echo "DB_PASS=$DB_PASS" >> /home/runner/creds.txt

    - name: Install Composer (global)
      run: |
        curl -sS https://getcomposer.org/installer -o composer-setup.php
        php composer-setup.php --install-dir=/usr/local/bin --filename=composer
        rm composer-setup.php
        composer --version || true

    - name: Download & prepare Pterodactyl Panel
      run: |
        set -e
        sudo mkdir -p $PANEL_PATH
        sudo chown $USER:$USER $PANEL_PATH
        cd $PANEL_PATH
        curl -L https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz | tar -xz
        chmod -R 755 storage bootstrap/cache || true
        cp .env.example .env || true

    - name: Configure .env (DB + APP_URL)
      run: |
        set -e
        cd $PANEL_PATH
        sed -i "s/DB_HOST=.*/DB_HOST=127.0.0.1/" .env
        sed -i "s/DB_PORT=.*/DB_PORT=3306/" .env
        sed -i "s/DB_DATABASE=.*/DB_DATABASE=pterodactyl/" .env
        sed -i "s/DB_USERNAME=.*/DB_USERNAME=ptero/" .env
        DBPASS="${{ steps.dbinfo.outputs.DB_PASS }}"
        sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=$DBPASS/" .env

        # APP_URL uses panel_domain input; fallback to tailscale ip if input empty
        INPUT_DOMAIN="${{ github.event.inputs.panel_domain }}"
        if [ -n "$INPUT_DOMAIN" ]; then
          APP_URL="http://${INPUT_DOMAIN}"
        else
          APP_URL="http://${{ steps.tsip.outputs.ts_ip }}"
        fi
        sed -i "s|APP_URL=.*|APP_URL=$APP_URL|" .env

        echo "APP_URL=$APP_URL" >> /home/runner/creds.txt

    - name: Install PHP deps, generate key, migrate, seed
      run: |
        set -e
        cd $PANEL_PATH
        composer install --no-dev --optimize-autoloader --no-interaction --prefer-dist || true
        php artisan key:generate --force || true
        php artisan config:cache || true
        php artisan migrate --force --seed || true
        sudo chown -R www-data:www-data $PANEL_PATH || true

    - name: Create admin user (attempt)
      id: admin
      run: |
        set -e
        cd $PANEL_PATH
        ADMIN_PASS=$(openssl rand -base64 12)
        php artisan p:user:make --email="${{ github.event.inputs.admin_email }}" --name="Admin" --username="admin" --password="$ADMIN_PASS" --admin || true
        echo "ADMIN_PASS=$ADMIN_PASS" >> $GITHUB_OUTPUT
        echo "PANEL_ADMIN_EMAIL=${{ github.event.inputs.admin_email }}" >> /home/runner/creds.txt
        echo "PANEL_ADMIN_USER=admin" >> /home/runner/creds.txt
        echo "PANEL_ADMIN_PASS=$ADMIN_PASS" >> /home/runner/creds.txt

    - name: Configure nginx (server_name = panel_domain)
      run: |
        set -e
        PANEL_DOMAIN="${{ github.event.inputs.panel_domain }}"
        sudo bash -c "cat > /etc/nginx/sites-available/pterodactyl <<'NGX'
server {
    listen 80;
    server_name PANEL_DOMAIN_PLACEHOLDER;

    root /var/www/pterodactyl/public;
    index index.php;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.2-fpm.sock;
    }

    location ~ /\.ht {
        deny all;
    }
}
NGX"
        # replace placeholder safely
        sudo sed -i "s|PANEL_DOMAIN_PLACEHOLDER|${PANEL_DOMAIN}|g" /etc/nginx/sites-available/pterodactyl
        sudo ln -sf /etc/nginx/sites-available/pterodactyl /etc/nginx/sites-enabled/pterodactyl
        sudo nginx -t || true
        sudo systemctl restart nginx || true

    - name: Final output & save creds
      run: |
        TS_IP="${{ steps.tsip.outputs.ts_ip }}"
        DBPASS="${{ steps.dbinfo.outputs.DB_PASS }}"
        SSH_PASS="${{ steps.sshinfo.outputs.SSH_PASS }}"
        ADMIN_PASS="${{ steps.admin.outputs.ADMIN_PASS }}"
        PANEL_DOMAIN="${{ github.event.inputs.panel_domain }}"
        echo "================================================"
        echo "      PTERODACTYL PANEL - ACCESS (MINIMAL)"
        echo "================================================"
        echo "Tailscale IP: $TS_IP"
        echo ""
        echo "SSH (via Tailscale):"
        echo "  ssh runner@$TS_IP"
        echo "  password: $SSH_PASS"
        echo ""
        echo "Panel (intended):"
        echo "  http://$PANEL_DOMAIN"
        echo "  If DNS not pointed, use Tailscale IP: http://$TS_IP"
        echo ""
        echo "Panel Admin (attempt created):"
        echo "  email: ${{ github.event.inputs.admin_email }}"
        echo "  username: admin"
        echo "  password: $ADMIN_PASS"
        echo ""
        echo "DB user: ptero"
        echo "DB pass: $DBPASS"
        echo ""
        echo "All creds saved to /home/runner/creds.txt (owner: runner). Grab it via SSH if needed."
        echo "Note: runner & data will be gone after ~6 hours."
        echo "================================================"
        echo ""
        echo "===== /home/runner/creds.txt ====="
        sudo cat /home/runner/creds.txt || true

    - name: Keep runner alive (6 hours)
      run: |
        echo "Sleeping up to 6 hours. Save everything now."
        sleep 21600
        

name: Pterodactyl & Bot WA Auto-Install (6 Jam)

on:
  workflow_dispatch: # Jalankan secara manual dari tab Actions

jobs:
  pterodactyl_install:
    runs-on: ubuntu-latest
    timeout-minutes: 350 # Maksimum waktu berjalan di GitHub

    steps:
      - name: Checkout Kode
        uses: actions/checkout@v4

      - name: Siapkan Tailscale & SSH
        uses: tailscale/github-action@v2
        with:
          oauth-client-id: ${{ secrets.TS_CLIENT_ID }} # Ganti jika Anda punya TS Secret
          oauth-secret: ${{ secrets.TS_SECRET }} # Ganti jika Anda punya TS Secret
          version: 1.62.1
          
      - name: Instal SSH Server dan Tetapkan Password
        run: |
          # Instal OpenSSH server
          sudo apt update -y
          sudo apt install -y openssh-server sshpass

          # Set password untuk user 'runner' menggunakan secret
          echo "runner:${{ secrets.SSH_PASSWORD }}" | sudo chpasswd
          
          # Hapus pesan peringatan (motd) agar terminal lebih bersih
          sudo rm /etc/update-motd.d/*
          sudo systemctl start ssh
          sudo systemctl enable ssh
          
          echo "Nginx & SSH sudah berjalan di runner."

      - name: Dapatkan IP & Password SSH
        run: |
          IP_ADDRESS=$(tailscale ip -4)
          
          echo "================================================="
          echo "AKSES UNTUK ANDA"
          echo "================================================="
          echo "IP Tailscale (untuk Web Panel & SSH): ${IP_ADDRESS}"
          echo "Username SSH: runner"
          echo "Password SSH: ${{ secrets.SSH_PASSWORD }}"
          echo "================================================="
          echo "::set-output name=ip_address::$IP_ADDRESS"

      - name: Persiapan Pterodactyl (Docker & Prasyarat)
        run: |
          echo "Memasang Docker dan Prasyarat..."
          sudo apt install -y docker.io wget curl unzip apt-transport-https ca-certificates software-properties-common
          sudo systemctl start docker
          sudo systemctl enable docker
          
          # Tambahkan user runner ke grup docker
          sudo usermod -aG docker runner
          
          # Download skrip instalasi Pterodactyl
          sudo wget -qO install.sh https://raw.githubusercontent.com/pterodactyl/installation-script/master/install.sh
          sudo chmod +x install.sh
          echo "Prasyarat Selesai."

      - name: Instalasi Pterodactyl Panel & Wings (Otomatis)
        env:
          DB_PASS: ${{ secrets.DB_PASSWORD }}
          APP_PASS: ${{ secrets.APP_PASSWORD }}
          ADMIN_MAIL: ${{ secrets.ADMIN_EMAIL }}
        run: |
          echo "Menjalankan instalasi utama Panel & Wings. Proses ini akan memakan waktu 10-30 menit."
          
          # Jalankan skrip utama sebagai sudo dengan variabel dari GitHub Secrets
          sudo ./install.sh --panel --wings --db-password $DB_PASS --app-password $APP_PASS --admin-email $ADMIN_MAIL --fqdn pterodactyl.test
          
          echo "Instalasi Pterodactyl Selesai."
          
      - name: Persiapan Lingkungan Bot WhatsApp (Node.js)
        uses: actions/setup-node@v4
        with:
          node-version: '20' # Versi Node.js yang stabil untuk bot

      - name: Setup dan Jalankan Bot WA (Placeholder)
        run: |
          mkdir -p /home/runner/whatsapp_bot
          cp whatsapp_bot_placeholder.sh /home/runner/whatsapp_bot/run_bot.sh
          chmod +x /home/runner/whatsapp_bot/run_bot.sh
          
          # Cek Node.js versi
          node -v
          
          echo "Lingkungan Bot WA siap di /home/runner/whatsapp_bot/."
          echo "Anda bisa SSH dan menginstal library bot (misalnya: 'npm install whatsapp-web.js')"
          echo "Skrip bot tidak otomatis berjalan, Anda harus SSH dan menjalankannya secara manual!"

      - name: Tahan Pekerjaan dan Tunggu Waktu Habis (agar VPS tetap aktif)
        run: |
          echo "Job akan berjalan selama 350 menit (sampai dibatalkan atau timeout)."
          sleep 21000 # Menunggu 350 menit

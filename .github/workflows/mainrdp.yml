name: Pterodactyl Panel (Instalasi MANUAL - FIX PERMISSION)

on:
  workflow_dispatch:
    inputs:
      ssh_password:
        description: 'Masukkan Password SSH/SUDO (Wajib)'
        required: true
        default: 'P@sswordAman123'
      tailscale_authkey:
        description: 'Tailscale Auth Key (Reusable - JANGAN GUNAKAN KEY YANG BOCOR)'
        required: true
        default: 'tskey-auth-...'

jobs:
  pterodactyl_manual_install:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    env:
      ADMIN_EMAIL: ashifaja123@gmail.com
      ADMIN_PASSWORD: ashifaja123
      PANEL_DOMAIN: panel.panelasip.my.id
      
      TS_SECRET: ${{ github.event.inputs.tailscale_authkey }} 
      DB_PASS: ${{ secrets.DB_PASSWORD }} 
      APP_PASS: ${{ secrets.APP_PASSWORD }} 
      
      PANEL_PATH: /var/www/pterodactyl
      RUNNER_USER: runner # User yang menjalankan job

    steps:
      - name: Checkout Kode
        uses: actions/checkout@v4

      - name: Instal Prasyarat, Fix Konflik, & Setting SSH/Docker
        env:
          SSH_PASS: ${{ github.event.inputs.ssh_password }}
        run: |
          echo "Memperbarui sistem & menginstal prasyarat dasar..."
          sudo apt update -y
          
          # --- PEMBERSIHAN KRITIS ---
          sudo systemctl stop apache2 || true
          sudo systemctl disable apache2 || true
          sudo apt remove --purge apache2* -y || true
          sudo apt-get remove -y containerd docker.io || true
          sudo apt-get purge -y containerd docker.io || true
          
          # --- INSTALASI DEPENDENCY MANUAL ---
          sudo add-apt-repository -y ppa:ondrej/php
          sudo apt update
          
          sudo apt install -y curl nginx mariadb-server redis-server composer unzip git
          sudo apt install -y php8.1-cli php8.1-fpm php8.1-mysql php8.1-zip php8.1-gd php8.1-mbstring php8.1-curl php8.1-xml php8.1-bcmath php8.1-redis
          
          # Instalasi Docker
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          
          # Pengaturan User SSH
          echo "${{ env.RUNNER_USER }}:${{ env.SSH_PASS }}" | sudo chpasswd
          sudo usermod -aG docker ${{ env.RUNNER_USER }}
          sudo systemctl start ssh
          sudo systemctl enable ssh
          
          echo "Semua prasyarat stabil siap."

      - name: Hubungkan ke Tailscale & Dapatkan IP
        id: ts_setup
        run: |
          # (Langkah Tailscale ini sudah terbukti berhasil, tidak diubah)
          set -e
          if [ -z "${{ env.TS_SECRET }}" ]; then 
            echo "::error::Auth Key Tailscale tidak diset. Proses gagal."
            exit 1
          fi
          
          echo "Menginstal dan menghubungkan Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          
          sudo tailscale up --authkey "${{ env.TS_SECRET }}" --ssh || true

          TS_IP=""
          for i in {1..10}; do
              TS_IP=$(sudo tailscale ip -4 | head -n1)
              if [ -n "$TS_IP" ]; then
                  break
              fi
              sleep 2
          done
          
          if [ -z "$TS_IP" ]; then
              echo "::error::Gagal mendapatkan IP Tailscale. Proses gagal."
              exit 1
          fi

          echo "IP Tailscale didapatkan: $TS_IP"
          echo "ts_ip=$TS_IP" >> $GITHUB_OUTPUT

      - name: Instalasi Pterodactyl Panel (Manual Langkah 1 - Aplikasi & Izin)
        run: |
          echo "Memulai instalasi Panel secara manual & mengoreksi izin..."
          
          # 1. Buat direktori (oleh root)
          sudo mkdir -p ${{ env.PANEL_PATH }}
          
          # PERBAIKAN KRITIS: Ubah kepemilikan ke user 'runner' agar bisa menulis file!
          sudo chown -R ${{ env.RUNNER_USER }}:${{ env.RUNNER_USER }} ${{ env.PANEL_PATH }}
          
          cd ${{ env.PANEL_PATH }}
          
          # 2. Unduh aplikasi (sekarang user 'runner' bisa menulis)
          curl -Lo panel.tar.gz https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz
          
          # 3. Ekstrak dan atur izin
          tar -xzvf panel.tar.gz
          chmod -R 755 storage/* bootstrap/cache/
          
          # 4. Instalasi Composer
          sudo composer install --no-dev --optimize-autoloader
          
          # 5. Konfigurasi Environment & Database (butuh sudo untuk akses database & php artisan)
          sudo cp .env.example .env
          sudo php artisan key:generate --force
          
          # Atur file .env
          sudo sed -i 's/DB_PASSWORD=/DB_PASSWORD=${{ env.DB_PASS }}/g' .env
          sudo sed -i 's/APP_URL=http:\/\/localhost/APP_URL=http:\/\/${{ env.PANEL_DOMAIN }}/g' .env
          sudo sed -i 's/APP_ENV=production/APP_ENV=local/g' .env
          
          # 6. Inisiasi Database
          sudo mysql -u root -e "CREATE DATABASE IF NOT EXISTS panel;" || true
          sudo php artisan migrate --force

          # 7. Konfigurasi Redis & Cache
          sudo php artisan p:environment:mail
          sudo php artisan p:environment:database --host=127.0.0.1 --port=3306 --database=panel --username=root --password='${{ env.DB_PASS }}'
          sudo php artisan p:environment:redis --host=127.0.0.1 --port=6379 --database=0
          sudo php artisan optimize

      - name: Buat Akun Admin & Queue Worker (Manual Langkah 2)
        run: |
          cd ${{ env.PANEL_PATH }}
          
          # 1. Buat Akun Admin
          echo "Membuat akun admin dengan kredensial tetap..."
          sudo php artisan p:user:make \
            --email="${{ env.ADMIN_EMAIL }}" \
            --name="AdminPanel" \
            --username="admin" \
            --password="${{ env.ADMIN_PASSWORD }}" \
            --admin || true
            
          # 2. Setting File Permission Final ke www-data (untuk webserver Nginx)
          sudo chown -R www-data:www-data ${{ env.PANEL_PATH }}
          
          # 3. Queue Worker (Menggunakan supervisor)
          sudo apt install -y supervisor
          sudo tee /etc/supervisor/conf.d/pterodactyl.conf > /dev/null <<EOF
          [program:pterodactyl]
          command=/usr/bin/php ${{ env.PANEL_PATH }}/artisan queue:work --queue=default --sleep=3 --tries=3 --daemon
          user=www-data
          autostart=true
          autorestart=true
          stopasgroup=true
          killasgroup=true
          stderr_logfile=/var/log/supervisor/pterodactyl-worker.log
          stdout_logfile=/var/log/supervisor/pterodactyl-worker.log
          EOF
          
          sudo supervisorctl reread
          sudo supervisorctl update
          sudo supervisorctl start pterodactyl

      - name: Konfigurasi Nginx (Manual Langkah 3 - FIX Welcome Page)
        env:
          FQDN: ${{ env.PANEL_DOMAIN }}
        run: |
          echo "Mengkonfigurasi Nginx agar mengarah ke Panel..."
          
          # Hapus konfigurasi default Nginx
          sudo rm -f /etc/nginx/sites-enabled/default
          
          # Buat konfigurasi Nginx untuk Panel (Menggunakan php8.1-fpm.sock)
          sudo tee /etc/nginx/sites-available/pterodactyl.conf > /dev/null <<EOF
          server {
              listen 80;
              server_name ${{ env.FQDN }};
          
              root ${{ env.PANEL_PATH }}/public;
              index index.php;
          
              access_log /var/log/nginx/pterodactyl.app-access.log;
              error_log /var/log/nginx/pterodactyl.app-error.log error;
          
              client_max_body_size 100m;
          
              location ~ \.php$ {
                  fastcgi_split_path_info ^(.+\.php)(/.+)$;
                  fastcgi_pass unix:/run/php/php8.1-fpm.sock;
                  fastcgi_index index.php;
                  include fastcgi_params;
                  fastcgi_param PHP_VALUE "upload_max_filesize = 100M \n post_max_size = 100M";
                  fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
                  fastcgi_param HTTP_PROXY "";
                  fastcgi_buffer_size 128k;
                  fastcgi_buffers 4 256k;
                  fastcgi_busy_buffers_size 256k;
              }
          
              location / {
                  try_files \$uri \$uri/ /index.php?\$query_string;
              }
          }
          EOF
          
          # Aktifkan V-Host
          sudo ln -s /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/pterodactyl.conf
          
          # Tes dan Restart Nginx
          sudo nginx -t
          sudo systemctl restart nginx

      - name: Final Output & Tahan Pekerjaan
        env:
          FQDN: ${{ env.PANEL_DOMAIN }}
          TS_IP: ${{ steps.ts_setup.outputs.ts_ip }}
        run: |
          echo "================================================"
          echo "  PTERODACTYL PANEL - INSTALASI MANUAL SUKSES!"
          echo "================================================"
          echo "WAKTU AKTIF: ~5.8 JAM"
          echo ""
          echo "1. AKSES PANEL (Via Tailscale):"
          echo "   URL: http://${{ env.FQDN }}"
          echo "   URL (Fallback IP Tailscale): http://${{ env.TS_IP }}"
          echo "   SEMUA MASALAH SUDAH DI-FIX. Halaman login Panel harusnya muncul."
          echo ""
          echo "2. KREDENSIAL ADMIN (Panel):"
          echo "   Email: ${{ env.ADMIN_EMAIL }}"
          echo "   Password: ${{ env.ADMIN_PASSWORD }}"
          echo "   (Username: admin)"
          echo ""
          echo "3. AKSES SSH (Via Tailscale):"
          echo "   SSH User: runner"
          echo "   SSH Pass: ${{ github.event.inputs.ssh_password }}"
          echo "   Command: ssh runner@${{ env.TS_IP }}"
          echo ""
          echo "================================================"
          echo "Panel Pterodactyl siap. Menunggu 350 menit..."
          sleep 21000

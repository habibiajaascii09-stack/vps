# .github/workflows/pterodactyl_install.yml

name: Instalasi Pterodactyl Panel via Docker + Tailscale (Final Stable & Anti-Stuck)

# Workflow hanya dapat dipicu secara manual (disarankan)
on:
  workflow_dispatch: 

jobs:
  pterodactyl_setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout Kode Repositori
        uses: actions/checkout@v4

      # =================================================================
      # A. SETUP DOCKER (SOLUSI KONFLIK DEPENDENSI)
      # =================================================================
      - name: Instalasi Docker dari Repositori Resmi
        run: |
          echo "Menginstal paket dasar dan kunci GPG..."
          sudo apt update
          sudo apt install -y ca-certificates curl gnupg lsb-release

          # Tambahkan kunci GPG resmi Docker
          sudo mkdir -m 0755 -p /etc/apt/keyrings
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg

          # Tambahkan repositori Docker ke sources.list
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null

          echo "Menginstal Docker CE, CLI, dan containerd.io..."
          sudo apt update
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

          # Menambahkan user ke grup docker
          sudo usermod -aG docker $USER
          
          echo "Docker siap digunakan. Memberi jeda 20 detik untuk stabilitas."
          sleep 20 
          
      # =================================================================
      # B. SETUP TAILSCALE (METODE STABIL & UNATTENDED)
      # =================================================================
      - name: Setup dan Login Tailscale (Anti-Stuck)
        timeout-minutes: 5 # Jika macet lebih dari 5 menit, step ini akan di-timeout
        run: |
          echo "Menjalankan Tailscale dalam mode container..."
          # Jalankan Tailscale Daemon sebagai container
          docker run -d --name=tailscaled \
            --network=host \
            --cap-add=NET_ADMIN \
            -v /var/lib:/var/lib \
            -v /dev/net/tun:/dev/net/tun \
            ghcr.io/tailscale/tailscale:latest \
            /bin/sh -c "tailscaled --cleanup; tailscaled"

          # Tunggu Tailscale Daemon inisialisasi
          sleep 5 
          
          # Login menggunakan Auth Key dengan flag --unattended
          # Ini mencegah macet jika memerlukan otorisasi browser
          docker exec tailscaled tailscale up \
            --authkey=${{ secrets.TAILSCALE_AUTH_KEY }} \
            --hostname=github-runner-${{ github.sha }} \
            --unattended
            
          echo "Tailscale telah dipicu untuk login. Otorisasi dari Dashboard Anda mungkin masih diperlukan."

      - name: Jeda 20 Detik Setelah Koneksi Tailscale
        run: |
          echo "Koneksi Tailscale terjalin. Memberi jeda 20 detik untuk propagasi IP."
          sleep 20 

      - name: Cetak Detail Akses Tailscale (Aman di Log)
        id: tailscale_info
        run: |
          # Dapatkan IP dari dalam container Tailscale
          IP_ADDR=$(docker exec tailscaled tailscale ip -4)
          # Dapatkan Hostname untuk akses MagicDNS
          HOSTNAME=$(docker exec tailscaled tailscale status --json | grep '"Self"' | cut -d: -f2 | cut -d, -f1 | tr -d ' "')
          
          echo "================================================="
          echo "  DETAIL AKSES TAILSCALE"
          echo "================================================="
          echo "1. Hostname Mesin (MagicDNS): -> ${HOSTNAME}.[tailnet-name].ts.net"
          echo "2. Alamat IP Tailscale (Aman): -> ${IP_ADDR}"
          echo "================================================="
          echo "::set-output name=tailscale_ip::${IP_ADDR}"
          
      # =================================================================
      # C. SETUP SERVER SSH (Akses Debugging via JuiceSSH)
      # =================================================================
      - name: Instalasi OpenSSH Server dan Konfigurasi Kunci
        env:
          PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }} 
        run: |
          echo "Menginstal OpenSSH Server..."
          sudo apt install -y openssh-server
          sudo systemctl start ssh
          sudo systemctl enable ssh
          
          # Konfigurasi Kunci
          mkdir -p ~/.ssh
          echo "$PUBLIC_KEY" >> ~/.ssh/authorized_keys
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/authorized_keys
          
          echo "SSH siap. User: 'runner'. Memberi jeda 20 detik untuk server."
          sleep 20 

      # =================================================================
      # D. INSTALASI PTERODACTYL PANEL via DOCKER
      # =================================================================
      - name: Menjalankan Container Pterodactyl Panel
        run: |
          echo "Menjalankan Pterodactyl Panel Container..."
          
          docker run -d --name panel \
          -p 8080:80 \
          -p 8081:443 \
          --env-file <(echo 'APP_URL=http://localhost') \
          --restart=always \
          ghcr.io/pterodactyl/panel:latest
          
          echo "Pterodactyl Panel berjalan. Memberi jeda 30 detik untuk inisialisasi Panel."
          sleep 30 

      # =================================================================
      # E. MEMBUAT AKUN ADMINISTRATOR PANEL
      # =================================================================
      - name: Membuat Akun Administrator Panel
        run: |
          echo "Menunggu Panel siap..."
          
          # Detail Akun Admin Anda
          docker exec panel php artisan p:user:make \
              --email="ashifaja123@gmail.com" \
              --username="ROCKWATER" \
              --name-first="ashif" \
              --name-last="aja123" \
              --password="Maesaroh" \
              --admin=1
              
          echo "================================================="
          echo "  AKUN ADMIN PTERODACTYL BERHASIL DIBUAT"
          echo "  Username: ROCKWATER"
          echo "  Password: Maesaroh (WAJIB GANTI SETELAH LOGIN!)"
          echo "================================================="

      # =================================================================
      # F. SETUP NGINX (Reverse Proxy)
      # =================================================================
      - name: Instalasi Nginx dan Konfigurasi Reverse Proxy
        run: |
          echo "Menginstal Nginx..."
          sudo apt install -y nginx
          
          # Konfigurasi Nginx untuk mengarahkan ke Docker Panel (8080)
          sudo tee /etc/nginx/sites-available/pterodactyl.conf > /dev/null <<EOT
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              server_name _; 
              
              location / {
                  proxy_pass http://127.0.0.1:8080; 
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_read_timeout 900;
              }
          }
          EOT

          # Mengaktifkan konfigurasi
          sudo ln -s /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          echo "Memuat ulang Nginx..."
          sudo systemctl reload nginx
          
      # =================================================================
      # G. MENJAGA RUNNER TETAP HIDUP (Akses Maksimal 6 Jam)
      # =================================================================
      - name: Runner Sleep 6 Jam
        run: |
          IP_ADDR_FINAL=${{ steps.tailscale_info.outputs.tailscale_ip }}
          echo "Instalasi SELESAI. Runner akan tidur selama 6 jam."
          echo "Akses Web: http://${IP_ADDR_FINAL}/"
          echo "Akses SSH: ssh runner@${IP_ADDR_FINAL}"
          sleep 6h
          echo "Job selesai / dibatalkan oleh GitHub setelah 6 jam."

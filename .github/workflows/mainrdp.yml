name: Ptero-Panel + Wings + Auto NodeJS Server (Tailscale)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Install Docker (official)
      run: |
        sudo apt update -y
        sudo apt install -y ca-certificates curl gnupg lsb-release
        sudo mkdir -p /etc/apt/keyrings
        curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /etc/apt/keyrings/docker.gpg
        echo \
          "deb [arch=$(dpkg --print-architecture) signed-by=/etc/apt/keyrings/docker.gpg] https://download.docker.com/linux/ubuntu \
          $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
        sudo apt update -y
        sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
        sudo systemctl enable docker --now
        docker --version
        sudo apt install -y curl jq net-tools

    - name: Setup Tailscale
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --auth-key "${TSKEY}" --hostname ghpanel --accept-routes
        TSIP=$(tailscale ip -4 | head -n 1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Create Docker network
      run: docker network create ptero-net || true

    - name: Deploy Pterodactyl Panel
      run: |
        docker rm -f ptero_panel || true
        docker run -d --name ptero_panel --network ptero-net \
          -p 8080:80 \
          ghcr.io/pterodactyl/panel:latest

    - name: Wait for artisan (auto detect path)
      id: wait_panel
      run: |
        for i in $(seq 1 200); do
          ARTISAN_PATH=$(docker exec ptero_panel find / -name artisan 2>/dev/null | head -n 1)
          if [ ! -z "$ARTISAN_PATH" ]; then
            DIR=$(dirname $ARTISAN_PATH)
            echo "dir=$DIR" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Waiting ($i)"
          sleep 5
        done
        echo "Artisan not found"
        exit 1

    - name: Configure .env
      run: |
        DIR=${{ steps.wait_panel.outputs.dir }}
        docker exec ptero_panel sh -c "cp ${DIR}/.env.example ${DIR}/.env"
        docker exec ptero_panel sh -c "sed -i \
          -e 's/APP_URL=.*/APP_URL=https:\/\/panelasip.my.id/' \
          -e 's/APP_TIMEZONE=.*/APP_TIMEZONE=Asia\/Jakarta/' \
          -e 's/DB_HOST=.*/DB_HOST=pterodb/' \
          ${DIR}/.env"

    - name: Generate APP_KEY & migrate
      run: |
        DIR=${{ steps.wait_panel.outputs.dir }}
        docker exec ptero_panel sh -c "php ${DIR}/artisan key:generate --force"
        docker exec ptero_panel sh -c "php ${DIR}/artisan migrate --force"

    - name: Create admin user
      run: |
        DIR=${{ steps.wait_panel.outputs.dir }}
        docker exec ptero_panel sh -c "php ${DIR}/artisan p:user:create \
          --email='ashifaja123@gmail.com' \
          --username='admin' \
          --name-first='Admin' \
          --name-last='Panel' \
          --password='passwordku123' \
          --admin=1 \
          --no-interaction || true"

    - name: Auto SSL
      run: |
        docker exec ptero_panel sh -c "cd ${DIR} && php artisan p:environment:setup"
        docker exec ptero_panel sh -c "cd ${DIR} && php artisan p:environment:mail"
        docker exec ptero_panel sh -c "cd ${DIR} && php artisan p:environment:database"
        docker exec ptero_panel sh -c "cd ${DIR} && php artisan p:environment:queue"
        docker exec ptero_panel sh -c "cd ${DIR} && php artisan p:environment:ssl --email ashifaja123@gmail.com --domain panelasip.my.id"

    - name: Deploy Wings (Tailscale private IP)
      run: |
        docker rm -f wings || true
        docker run -d --name wings --network ptero-net \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v /etc/pterodactyl:/etc/pterodactyl \
          ghcr.io/pterodactyl/wings:latest \
          --config /etc/pterodactyl/config.yml

    - name: Import NodeJS Egg & Create Node
      run: |
        PANEL_URL="https://panelasip.my.id"
        API_KEY="${{ secrets.PTERO_API_KEY }}"
        curl -X POST "$PANEL_URL/api/application/nests/1/eggs" \
          -H "Authorization: Bearer $API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"egg":{"name":"NodeJS Bot","docker_images":["ghcr.io/pterodactyl/yolks:node-16"],"startup":"node server.js"}}'
        NODE_IP=$TSIP
        curl -X POST "$PANEL_URL/api/application/nodes" \
          -H "Authorization: Bearer $API_KEY" \
          -H "Content-Type: application/json" \
          -d "{\"name\":\"NodeJS-Node\",\"fqdn\":\"$NODE_IP\",\"scheme\":\"http\",\"memory_overallocate\":0,\"disk_overallocate\":0,\"daemonBase\":\"/etc/pterodactyl\"}"

    - name: Create Allocation
      run: |
        NODE_ID=$(curl -s -H "Authorization: Bearer $API_KEY" "$PANEL_URL/api/application/nodes" | jq '.data[0].attributes.id')
        curl -X POST "$PANEL_URL/api/application/nodes/$NODE_ID/allocations" \
          -H "Authorization: Bearer $API_KEY" \
          -H "Content-Type: application/json" \
          -d '{"allocation":{"ip":"'"$TSIP"'","port":3000}}'

    - name: Create NodeJS Server
      run: |
        curl -X POST "$PANEL_URL/api/application/servers" \
          -H "Authorization: Bearer $API_KEY" \
          -H "Content-Type: application/json" \
          -d '{
            "name":"panel",
            "user":1,
            "egg":2,
            "docker_image":"ghcr.io/pterodactyl/yolks:node-16",
            "environment":{},
            "startup":"node server.js",
            "limits":{"memory":4096,"swap":0,"disk":20000,"io":500,"cpu":200},
            "feature_limits":{}
          }'

    - name: Display Panel Info
      run: |
        echo "PANEL: https://panelasip.my.id"
        echo "LOGIN EMAIL : ashifaja123@gmail.com"
        echo "LOGIN PASS  : passwordku123"
        echo "TAILSCALE IP: $TSIP"
        echo "AUTO SERVER: panel (NodeJS Bot WA)"

    - name: Keep runner alive for 6 hours
      run: sleep 6h

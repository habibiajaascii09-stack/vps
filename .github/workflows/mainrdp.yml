name: Tailscale Runner HP Version (Max 6 Hours)

# Trigger workflow secara manual dengan input
on:
  workflow_dispatch:
    inputs:
      # INPUT BARU untuk Kunci Otorisasi Tailscale (sesuai gambar)
      tailscale_auth_key:
        description: 'Kunci Otorisasi Tailscale'
        required: true
        default: ''
      # INPUT BARU untuk Password SSH Runner
      runner_password:
        description: 'Password untuk User SSH Runner (Perhatian: terlihat di log)'
        required: true
        default: 'vpspass123' # Ganti dengan password yang Anda inginkan

jobs:
  temporary-vps-access:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup Tailscale 
      - name: Set Up Tailscale
        uses: tailscale/github-action@v2
        with:
          # MENGGUNAKAN INPUT workflow_dispatch BUKAN secrets.TS_AUTH_KEY
          authkey: ${{ github.event.inputs.tailscale_auth_key }} 
          hostname: github-runner-${{ github.run_id }}
          
      # 2. Instal SSH Server
      - name: Install OpenSSH Server
        run: sudo apt update && sudo apt install -y openssh-server

      # 3. MENGATUR PASSWORD dengan 'passwd'
      - name: Set Password for Runner User
        run: echo -e "${{ github.event.inputs.runner_password }}\n${{ github.event.inputs.runner_password }}" | sudo passwd runner
        env:
          # Menggunakan INPUT runner_password BUKAN secret
          RUNNER_PASSWORD: ${{ github.event.inputs.runner_password }} 

      # 4. Mendapatkan IP Address dan Informasi Koneksi
      - name: Get Connection Information
        run: |
          ip_address=$(tailscale ip -4)
          echo "### âœ… Runner Siap diakses via SSH" >> $GITHUB_STEP_SUMMARY
          echo "SSH Command: ssh runner@${ip_address}" >> $GITHUB_STEP_SUMMARY
          echo "Username: **runner**" >> $GITHUB_STEP_SUMMARY
          echo "Password: **${{ github.event.inputs.runner_password }}** (Lihat log untuk detail)" >> $GITHUB_STEP_SUMMARY
          echo "Timeout: 350 menit" >> $GITHUB_STEP_SUMMARY
          echo "RUNNER_IP=${ip_address}" >> $GITHUB_ENV

      - name: Hold Job and Wait for Timeout
        run: |
          echo "SSH Access: runner@${{ env.RUNNER_IP }}"
          echo "Job akan berjalan selama 350 menit (atau sampai dibatalkan)."
          sleep 350m
          
      - name: Job Finished
        if: always()
        run: echo "Job selesai. Runner telah dimatikan."

name: Ubuntu Desktop + RDP + Tailscale + Pterodactyl Panel + NodeJS(OpenWA)

on:
  workflow_dispatch:
    inputs:
      confirm:
        description: "Run full Pterodactyl + OpenWA setup?"
        required: true
        default: "yes"

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Update system
      run: sudo apt update -y && sudo apt upgrade -y

    - name: Install XFCE desktop
      run: |
        sudo DEBIAN_FRONTEND=noninteractive apt install -y xfce4 xfce4-goodies dbus-x11

    - name: Install xRDP
      run: |
        sudo apt install -y xrdp
        sudo systemctl enable --now xrdp

    - name: Create RDP user
      run: |
        sudo useradd -m -s /bin/bash ubuntu || true
        echo "ubuntu:admin123" | sudo chpasswd
        sudo usermod -aG sudo ubuntu || true

    - name: Install Docker
      run: |
        curl -fsSL https://get.docker.com | sh
        sudo systemctl enable --now docker
        sudo usermod -aG docker ubuntu || true

    - name: Install Tailscale and start
      env:
        TSKEY: ${{ secrets.TSKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey="$TSKEY" --accept-routes --ssh --accept-dns=false || true
        echo "TAILSCALE_IP=$(tailscale ip -4 | head -n1)" > /tmp/tailscale_ip.txt

    - name: Show basic host specs
      run: |
        echo "===== HOST SPECS ====="
        echo "OS: $(lsb_release -ds || cat /etc/os-release)"
        echo "Uptime: $(uptime -p)"
        echo "CPU(s): $(nproc) cores"
        free -m
        df -h --output=source,size,used,avail,pcent,target | sed -n '1,5p'
        echo "======================"

    - name: Start MariaDB (container)
      run: |
        docker rm -f ptero_mysql || true
        docker run -d --name ptero_mysql \
          -e MARIADB_ROOT_PASSWORD=root123 \
          -e MARIADB_DATABASE=ptero \
          -e MARIADB_USER=ptero \
          -e MARIADB_PASSWORD=ptero123 \
          mariadb:10.6

    - name: Start Pterodactyl Panel (container)
      run: |
        docker rm -f ptero_panel || true
        docker run -d --name ptero_panel \
          --link ptero_mysql:mysql \
          -p 8080:80 \
          ghcr.io/pterodactyl/panel:latest

    - name: Wait for panel filesystem (look for artisan)
      id: wait_panel
      run: |
        for i in $(seq 1 60); do
          if docker exec ptero_panel test -f /var/www/pterodactyl/artisan >/dev/null 2>&1; then
            echo "dir=/var/www/pterodactyl" >> $GITHUB_OUTPUT
            exit 0
          fi
          if docker exec ptero_panel test -f /var/www/html/artisan >/dev/null 2>&1; then
            echo "dir=/var/www/html" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Waiting for panel... ($i)"
          sleep 3
        done
        echo "Panel filesystem never appeared" >&2
        exit 1

    - name: Ensure .env (safe) and configure DB
      run: |
        DIR=${{ steps.wait_panel.outputs.dir }}
        # if .env.example exists copy, otherwise create minimal .env
        if docker exec ptero_panel test -f $DIR/.env.example >/dev/null 2>&1; then
          docker exec ptero_panel cp $DIR/.env.example $DIR/.env || true
        else
          docker exec ptero_panel sh -c "cat > $DIR/.env <<'EOF'
APP_ENV=production
APP_DEBUG=false
APP_URL=http://127.0.0.1:8080
DB_CONNECTION=mysql
DB_HOST=mysql
DB_PORT=3306
DB_DATABASE=ptero
DB_USERNAME=ptero
DB_PASSWORD=ptero123
EOF"
        fi
        # ensure DB host is correct (link name)
        docker exec ptero_panel sh -c "sed -i 's|DB_HOST=.*|DB_HOST=mysql|' $DIR/.env || true"

    - name: Run artisan setup (key+migrate) + create admin
      run: |
        DIR=${{ steps.wait_panel.outputs.dir }}
        docker exec ptero_panel sh -c "cd $DIR && php artisan key:generate --force || true"
        # Wait DB a bit
        sleep 6
        docker exec ptero_panel sh -c "cd $DIR && php artisan migrate --force || true"
        ADMIN_PASS=$(openssl rand -hex 6)
        docker exec ptero_panel sh -c "cd $DIR && php artisan p:user:make --email='ashifaja123@gmail.com' --username='admin' --name-first='Admin' --name-last='User' --password='${ADMIN_PASS}' --admin=1 || true"
        echo "ADMIN_PASS=${ADMIN_PASS}" > /tmp/panel_admin.txt

    - name: Import NodeJS Egg (OpenWA template)
      run: |
        # download community nodejs egg (parkervcp generic nodejs)
        wget -q -O /tmp/egg-nodejs.json https://raw.githubusercontent.com/parkervcp/eggs/master/generic/nodejs/egg-nodejs.json || true
        # copy into container and import via artisan (if command exists)
        docker cp /tmp/egg-nodejs.json ptero_panel:/tmp/egg-nodejs.json || true
        docker exec ptero_panel sh -c "php artisan p:egg:import /tmp/egg-nodejs.json || true"

    - name: Install Wings (daemon) as Docker container (example)
      run: |
        # create a minimal wings config (will need to register with panel via token)
        mkdir -p /tmp/wings
        cat > /tmp/wings/config.yml <<'EOF'
# Minimal wings config (you will need to update this to match your panel URL & token)
bind_interface: 0.0.0.0
remote: http://127.0.0.1:8080
token: REPLACE_WITH_PANEL_DAEMON_TOKEN
EOF
        # run wings container (note: you must update config token later)
        docker rm -f ptero_wings || true
        docker run -d --name ptero_wings --restart unless-stopped \
          -v /tmp/wings:/etc/pterodactyl \
          -p 8081:8081 \
          pterodactyl/wings:latest || true

    - name: Print connection info + specs
      run: |
        TS=$(tailscale ip -4 | head -n1 || true)
        echo "======================================"
        echo "RDP (xRDP) login: ubuntu / admin123  (port 3389)"
        echo "Tailscale IP: $TS"
        echo ""
        echo "Panel (via Tailscale): http://$TS:8080"
        echo "Panel Admin email: ashifaja123@gmail.com"
        cat /tmp/panel_admin.txt || true
        echo ""
        echo "If the panel URL doesn't respond in your mobile browser, open Chrome inside the RDP session and visit http://localhost:8080"
        echo "Wings container started (may need config token)."
        echo "======================================"
        echo ""
        echo "===== HOST SPECS (MiB) ====="
        awk '/MemTotal/ {print $2/1024 " MiB RAM"}' /proc/meminfo || true
        free -m
        df -m | sed -n '1,5p'
        echo "CPU cores: $(nproc)"
        uname -a
        echo "============================="

    - name: Keep runner alive (6h)
      run: |
        echo "Runner will stay alive for 6 hours to allow you to RDP in and finalize setup."
        sleep 6h

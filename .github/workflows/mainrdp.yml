name: Panel

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Update system
      run: sudo apt update && sudo apt upgrade -y

    - name: Install dependencies
      run: |
        sudo apt install -y curl wget unzip tar nginx mariadb-server php php-cli php-mysql php-curl php-zip php-mbstring php-xml php-bcmath php-gd php-fpm jq

    - name: Setup Tailscale
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --auth-key "$TSKEY" --hostname ghpanel --accept-routes
        TSIP=$(tailscale ip -4 | head -n1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Setup MySQL
      run: |
        sudo systemctl start mysql
        sudo mysql -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root123'; FLUSH PRIVILEGES;"
        sudo mysql -uroot -proot123 -e "CREATE DATABASE panel;"

    - name: Download Panel
      run: |
        cd /var/www
        sudo rm -rf panel
        sudo mkdir panel
        sudo chown $USER:$USER panel
        cd panel
        curl -Lo panel.tar.gz https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz
        tar -xzvf panel.tar.gz
        cp .env.example .env

    - name: Install Composer
      run: |
        cd /var/www/panel
        curl -sS https://getcomposer.org/installer | php
        php composer.phar install --no-dev --optimize-autoloader

    - name: Configure .env
      run: |
        cd /var/www/panel
        php artisan key:generate
        sed -i "s/DB_HOST=.*/DB_HOST=127.0.0.1/" .env
        sed -i "s/DB_DATABASE=.*/DB_DATABASE=panel/" .env
        sed -i "s/DB_USERNAME=.*/DB_USERNAME=root/" .env
        sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=root123/" .env

    - name: Migrate Database
      run: |
        cd /var/www/panel
        sleep 10
        php artisan migrate --force

    - name: Create Admin Account
      run: |
        cd /var/www/panel
        php artisan p:user:make \
          --email="ashifaja123@gmail.com" \
          --username="ashifaja123" \
          --name="ashifaja123" \
          --password="Maesaroh" \
          --admin=1

    - name: Fix Permissions
      run: |
        sudo chown -R www-data:www-data /var/www/panel
        sudo chmod -R 755 /var/www/panel

    - name: Create nginx.conf automatically
      run: |
        sudo tee /etc/nginx/sites-available/panel <<EOF
server {
    listen 80;
    server_name _;
    root /var/www/panel/public;
    index index.php;
    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }
    location ~ \.php$ {
        include snippets/fastcgi-php.conf;
        fastcgi_pass unix:/run/php/php8.1-fpm.sock;
    }
    location ~* \.(jpg|jpeg|png|gif|ico|css|js)$ {
        expires max;
        log_not_found off;
    }
}
EOF
        sudo ln -sf /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/panel
        sudo systemctl restart nginx

    - name: Show Panel Info
      run: |
        echo "===================================" 
        echo " PTERODACTYL PANEL SUCCESS RUNNING "
        echo "===================================" 
        echo "Tailscale IP Panel: http://${TSIP}"
        echo "Username: ashifaja123"
        echo "Password: Maesaroh"
        echo "Email: ashifaja123@gmail.com"
        echo "===================================" 

    - name: Sleep 6 hours
      run: sleep 21600

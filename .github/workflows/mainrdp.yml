name: Tailscale Runner HP Version (Pterodactyl) - FIX

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: 'Kunci Otorisasi Tailscale'
        required: true
        default: ''
      runner_password:
        description: 'Password untuk User SSH Runner (Perhatian: terlihat di log)'
        required: true
        default: 'vpspass123' 

jobs:
  temporary-vps-access:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup Tailscale & SSH
      - name: Setup Tailscale dan SSH
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ github.event.inputs.tailscale_auth_key }} 
          hostname: github-runner-${{ github.run_id }}
          
      - name: Install OpenSSH Server dan Atur Password
        run: |
          sudo apt update
          sudo apt install -y openssh-server
          
          # MENGATUR PASSWORD SSH
          echo -e "${{ github.event.inputs.runner_password }}\n${{ github.event.inputs.runner_password }}" | sudo passwd runner

      # =========================================================
      # â¬‡ï¸ AWAL MODIFIKASI DAN PERBAIKAN â¬‡ï¸
      # =========================================================

      - name: âš™ï¸ Install Docker dan Docker Compose
        run: |
          echo "Menginstal Docker dan menambahkan user runner ke grup docker..."
          sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_review -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt update
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin
          # Perubahan grup akan diterapkan di langkah berikutnya

      - name: ðŸš€ Deploy Pterodactyl Panel (Jalankan Docker)
        run: |
          # Sekarang Docker dapat dijalankan dengan sudo untuk menghindari masalah izin
          mkdir -p /home/runner/pterodactyl
          cd /home/runner/pterodactyl

          wget -q -O docker-compose.yml https://raw.githubusercontent.com/pterodactyl/panel/develop/docker-compose.yml
          cp .env.example .env
          
          # Gunakan 'sudo' untuk menjalankan Docker Compose agar izin grup runner tidak jadi masalah
          echo "Menjalankan container Pterodactyl..."
          sudo docker compose up -d

      - name: ðŸŒ Setup Nginx dan Konfigurasi Tailscale
        run: |
          TS_IP=$(tailscale ip -4)
          echo "Tailscale IP Ditemukan: $TS_IP"
          
          # 1. Instal Nginx
          sudo apt install -y nginx

          # 2. Hapus default config
          sudo rm /etc/nginx/sites-enabled/default
          
          # 3. Buat konfigurasi Nginx (Menggunakan IP Tailscale)
          sudo tee /etc/nginx/sites-available/pterodactyl.conf > /dev/null <<EOF
server {
    listen 80;
    server_name $TS_IP;

    root /home/runner/pterodactyl/public;

    index index.html index.php;
    
    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        # Mengarahkan ke container 'panel' melalui port 9000
        # Catatan: Ini mengasumsikan Docker membuat jembatan yang dapat diakses oleh host
        fastcgi_split_path_info ^(.+\.php)(/.+)$;
        fastcgi_pass 172.18.0.2:9000; # Seringkali alamat default Docker Bridge / Panel Service
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
        fastcgi_param PATH_INFO \$fastcgi_path_info;
    }
}
EOF
          # 4. Aktifkan konfigurasi Nginx dan restart
          sudo ln -s /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/
          sudo systemctl restart nginx
          echo "Pterodactyl siap diakses melalui Nginx di IP Tailscale: $TS_IP"
          echo "RUNNER_IP=$TS_IP" >> $GITHUB_ENV # Simpan IP Tailscale

      # =========================================================
      # â¬†ï¸ AKHIR MODIFIKASI â¬†ï¸
      # =========================================================
      
      # 4. Mendapatkan IP Address dan Informasi Koneksi
      - name: Get Connection Information
        run: |
          # Output SSH dan Web Access
          ip_address=${{ env.RUNNER_IP }}
          echo "### âœ… Runner Siap diakses via Web!" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ PENTING: Anda harus menyelesaikan Setup Pterodactyl via web." >> $GITHUB_STEP_SUMMARY
          # ... (sisanya sama)
          # ... (sisanya sama)

      - name: Hold Job and Wait for Timeout
        run: |
          echo "Akses web diaktifkan di IP Tailscale: ${{ env.RUNNER_IP }}"
          echo "Job akan berjalan selama 350 menit (atau sampai dibatalkan). Segera selesaikan Setup Pterodactyl Anda!"
          sleep 350m
          
      - name: Job Finished
        if: always()
        run: echo "Job selesai. Runner telah dimatikan."

name: Deploy VPS Sementara via SSH dan Tailscale

# Trigger workflow secara manual
on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: 'Kunci Otorisasi Tailscale (Dibutuhkan untuk terhubung ke Tailnet Anda)'
        required: true
        default: ''

jobs:
  vps_runner:
    # Menggunakan runner Ubuntu terbaru
    runs-on: ubuntu-latest

    steps:
      - name: â³ Siapkan Lingkungan dan Install Tailscale
        run: |
          echo "Memulai instalasi Tailscale dan SSH..."
          
          # Perbarui dan Install Kebutuhan Dasar
          sudo apt update
          # Pastikan curl, openssh-server, dan gpg sudah terinstal
          sudo apt install -y curl wget openssh-server gpg

          # --- PERBAIKAN FINAL GPG/404 ERROR ---
          # 1. Unduh Kunci Publik GPG yang disederhanakan
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.key | \
          sudo gpg --dearmor -o /usr/share/keyrings/tailscale-archive-keyring.gpg
          
          # 2. Tambahkan Repositori
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | \
          sudo tee /etc/apt/sources.list.d/tailscale.list > /dev/null
          # --- AKHIR PERBAIKAN ---
          
          # Lanjutkan Instalasi Tailscale
          sudo apt update
          sudo apt install -y tailscale

          # Otentikasi Tailscale dengan Kunci yang Diberikan
          echo "Melakukan Otentikasi Tailscale dengan Kunci yang Diberikan..."
          sudo tailscale up --authkey=${{ github.event.inputs.tailscale_auth_key }} --ssh
          
          # Dapatkan IP Tailscale dan simpan sebagai variabel lingkungan
          TS_IP=$(tailscale ip -4)
          echo "TAILSCALE_IP=$TS_IP" >> $GITHUB_ENV

      - name: ðŸ” Buat User dan Password SSH
        run: |
          # Pengaturan user dan pembuatan password acak
          VPS_USER="vpsuser"
          # Membuat password acak
          VPS_PASSWORD=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 12 | head -n 1)
          
          # Membuat user baru tanpa password awal
          sudo adduser --disabled-password --gecos "" $VPS_USER
          # Mengatur password
          echo "$VPS_USER:$VPS_PASSWORD" | sudo chpasswd
          # Menambahkan user ke grup sudo
          sudo usermod -aG sudo $VPS_USER
          
          # Catat password untuk output log
          echo "VPS_PASSWORD=$VPS_PASSWORD" >> $GITHUB_ENV

      - name: ðŸ”‘ Catat Informasi Akses dan Tutorial SSH
        run: |
          echo "================================================="
          echo "      âœ¨ Informasi Akses VPS (SSH) Tersedia! âœ¨"
          echo "================================================="
          echo "Alamat IP Tailscale: ${{ env.TAILSCALE_IP }}"
          echo "Username SSH: **vpsuser**"
          echo "Password SSH: **${{ env.VPS_PASSWORD }}**"
          echo ""
          echo "ðŸ“¢ Tutorial Akses (Menggunakan Juicessh atau SSH Client lain):"
          echo "1. Pastikan perangkat yang Anda gunakan sudah terinstal **Tailscale** dan ter-Otorisasi di jaringan yang sama dengan VPS ini."
          echo "2. Buka klien SSH Anda (misalnya Juicessh)."
          echo "3. Buat koneksi SSH baru dengan detail berikut:"
          echo "   - **Host/Alamat**: ${{ env.TAILSCALE_IP }}"
          echo "   - **Port**: 22"
          echo "   - **Username**: vpsuser"
          echo "   - **Password**: ${{ env.VPS_PASSWORD }}"
          echo "4. Klik Connect! Jika diminta, terima kunci host SSH."
          echo "================================================="
          
      - name: ðŸ•’ Jaga Runner Tetap Aktif Selama 6 Jam
        run: |
          echo "Runner akan tetap berjalan selama 6 jam (360 menit)."
          echo "Waktu mulai: $(date)"
          # Menjaga runner tetap berjalan selama 360 menit (6 jam)
          sleep 360m
          echo "Waktu habis: $(date)"
          echo "Runner akan dimatikan. Koneksi SSH Anda akan terputus."

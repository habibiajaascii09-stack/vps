name: deploy
on: workflow_dispatch

jobs:
  run:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Install packages (NO DOCKER CONFLICT)
      run: |
        sudo apt update
        sudo apt install -y nginx mysql-server php php-mysql php-cli php-fpm php-zip php-gd php-mbstring php-curl php-bcmath php-json php-xml php-tokenizer php-fileinfo
        sudo systemctl stop apache2 || true

    - name: Start MySQL
      run: |
        sudo systemctl start mysql
        mysql -u root -e "CREATE DATABASE panel;"
        mysql -u root -e "ALTER USER 'root'@'localhost' IDENTIFIED WITH mysql_native_password BY 'root'; FLUSH PRIVILEGES;"

    - name: Start Pterodactyl Panel
      run: |
        git clone https://github.com/pterodactyl/panel.git /var/www/panel
        cd /var/www/panel
        cp .env.example .env
        composer install --no-dev --optimize-autoloader
        php artisan key:generate

    - name: Configure DB in .env
      run: |
        sed -i "s/DB_HOST=.*/DB_HOST=127.0.0.1/" /var/www/panel/.env
        sed -i "s/DB_DATABASE=.*/DB_DATABASE=panel/" /var/www/panel/.env
        sed -i "s/DB_USERNAME=.*/DB_USERNAME=root/" /var/www/panel/.env
        sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=root/" /var/www/panel/.env

    - name: Wait DB + migrate
      run: |
        cd /var/www/panel
        for i in {1..20}; do
          php artisan migrate --seed && break
          echo "($i) DB not ready..."
          sleep 3
        done

    - name: Create Admin Account
      run: |
        cd /var/www/panel
        php artisan p:user:make --email="ashifaja123@gmail.com" --username="ashifaja123" --name-first="Ashif" --name-last="Aja" --password="Maesaroh" --admin=1

    - name: Configure nginx
      run: |
        sudo rm -f /etc/nginx/sites-enabled/default
        sudo bash -c 'echo "
        server {
            listen 80;
            root /var/www/panel/public;
            index index.php;
            location / {
                try_files \$uri \$uri/ /index.php?\$query_string;
            }
            location ~ \.php$ {
                include snippets/fastcgi-php.conf;
                fastcgi_pass unix:/run/php/php-fpm.sock;
            }
        }" > /etc/nginx/sites-available/panel.conf'
        sudo ln -s /etc/nginx/sites-available/panel.conf /etc/nginx/sites-enabled/panel.conf
        sudo systemctl restart nginx

    - name: Setup Tailscale
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --auth-key "${TSKEY}" --hostname ghpanel --accept-routes
        TSIP=$(tailscale ip -4 | head -n1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Display Panel Info
      run: |
        echo " "
        echo "=================== PANEL DEPLOYED ==================="
        echo "URL PANEL       : http://$TSIP"
        echo "ADMIN EMAIL     : ashifaja123@gmail.com"
        echo "ADMIN USERNAME  : ashifaja123"
        echo "ADMIN PASSWORD  : Maesaroh"
        echo "======================================================"
        echo " "

    - name: Sleep 6 Hours
      run: sleep 6h

name: Ptero Docker + Tailscale Lite

on:
  workflow_dispatch:

jobs:
  ptero_setup:
    name: Pterodactyl Setup Runner
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # =========================================================
      # 1. Install Docker & SSH Server
      # =========================================================
      - name: Install Docker & SSH Server
        run: |
          echo "Menginstal Docker dan SSH Server..."
          sudo apt update -y
          # Install SSH Server
          sudo apt install -y openssh-server curl wget git
          # Install Docker (menggunakan skrip resmi, ini lebih baik daripada apt)
          curl -fsSL https://get.docker.com | sh
          sudo systemctl start docker || true

      # =========================================================
      # 2. Install & Start Tailscale & SSH Setup (Perbaikan Instalasi)
      # =========================================================
      - name: Install & Start Tailscale & SSH Setup
        id: step2 
        env:
          TAILSCALE_KEY: ${{ secrets.TAILSCALE_KEY }}
          RUNNER_USER: runner
          RUNNER_PASS: temp${{ github.run_id }} 
        run: |
          echo "--- ðŸ”‘ Menginstal dan Otentikasi Tailscale (FIXED) ---"
          
          # FIX: Menggunakan skrip instalasi Tailscale resmi (Mengatasi 404/command not found)
          curl -fsSL https://pkgs.tailscale.com/install.sh | sudo bash 
          
          echo "Menjalankan Tailscale dengan auth key..."
          sudo tailscale up --authkey="${TAILSCALE_KEY}" --hostname=gh-runner-${{ github.run_id }} --accept-routes

          sleep 5
          TS_IP=$(tailscale ip -4 2>/dev/null || true)

          if [ -n "$TS_IP" ]; then
            echo "âœ… Tailscale IP berhasil didapatkan: $TS_IP"
          else
            echo "âŒ Gagal mendapatkan IP Tailscale"
          fi
          
          # Setup User SSH Sementara
          echo "Menyiapkan akun SSH/VPS sementara..."
          sudo useradd -m -s /bin/bash $RUNNER_USER
          echo "$RUNNER_USER:$RUNNER_PASS" | sudo chpasswd
          
          # Mengizinkan Login Password (Wajib untuk JuiceSSH/Termux)
          sudo sed -i 's/#PermitRootLogin prohibit-password/PermitRootLogin yes/' /etc/ssh/sshd_config
          sudo sed -i 's/PasswordAuthentication no/PasswordAuthentication yes/' /etc/ssh/sshd_config
          sudo systemctl restart sshd

          echo "::set-output name=ssh_pass::${RUNNER_PASS}"

      # =========================================================
      # 3. Start MariaDB Container (Kode Anda)
      # =========================================================
      - name: Start MariaDB
        run: |
          echo "Menjalankan MariaDB Container..."
          docker rm -f db || true
          docker run -d --name db \
            -e MARIADB_ROOT_PASSWORD=rootpass \
            -e MARIADB_DATABASE=ptero \
            -e MARIADB_USER=ptero \
            -e MARIADB_PASSWORD=ptero123 \
            mariadb:10.6

      # =========================================================
      # 4. Start Pterodactyl Panel + Init DB + Create Admin & Output Info
      # =========================================================
      - name: Start Panel + init DB + create admin
        id: panel_setup
        run: |
          ADMIN_PASS=$(openssl rand -hex 6)
          docker rm -f panel || true
          echo "Menjalankan Pterodactyl Panel Container..."
          docker run -d --name panel \
            --link db:db \
            -p 8080:80 \
            -e DB_CONNECTION=mysql \
            -e DB_HOST=db \
            -e DB_PORT=3306 \
            -e DB_DATABASE=ptero \
            -e DB_USERNAME=ptero \
            -e DB_PASSWORD=ptero123 \
            ghcr.io/pterodactyl/panel:latest || true

          # wait filesystem & artisan availability
          for i in $(seq 1 60); do
            if docker exec panel sh -c "test -f /var/www/pterodactyl/artisan" >/dev/null 2>&1 || docker exec panel sh -c "test -f /var/www/html/artisan" >/dev/null 2>&1; then
              echo "Panel filesystem ready."
              break
            fi
            echo "Waiting for panel container..."
            sleep 2
          done

          # find artisan path and app dir
          if docker exec panel sh -c "test -f /var/www/pterodactyl/artisan" >/dev/null 2>&1; then
            APP_DIR="/var/www/pterodactyl"
          else
            APP_DIR="/var/www/html"
          fi

          # ensure .env and key, migrate, create admin
          docker exec panel sh -c "cd ${APP_DIR} && cp .env.example .env 2>/dev/null || true"
          docker exec panel sh -c "cd ${APP_DIR} && sed -i 's|APP_URL=.*|APP_URL=http://127.0.0.1:8080|' .env || true"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan key:generate --force || true"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan migrate --force || true"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan p:user:make --email='ashifaja123@gmail.com' --username='admin' --name-first='Admin' --name-last='User' --password='${ADMIN_PASS}' --admin=1 || true"

          # capture Tailscale IP & public IP
          TS_IP=$(tailscale ip -4 2>/dev/null || true)
          PUBLIC_IP=$(curl -s https://api.ipify.org || echo "127.0.0.1")
          
          # Ambil password SSH dari Langkah 2
          SSH_PASS="${{ steps.step2.outputs.ssh_pass }}"

          echo "============================================================"
          echo "               âœ… Pterodactyl Panel (Docker) READY          "
          echo "============================================================"
          
          # --- Akses Panel ---
          echo "Panel URL (Tailscale): http://${TS_IP}:8080"
          echo "Panel URL (Publik):    http://${PUBLIC_IP}:8080"
          echo ""
          echo "Admin User  : admin"
          echo "Admin Pass  : ${ADMIN_PASS}"
          echo "DB User     : ptero  DB Pass: ptero123"
          echo "------------------------------------------------------------"

          # --- Akses VPS/SSH (JuiceSSH/Termux) ---
          echo "Akses VPS/Runner via Tailscale (JuiceSSH/Termux)"
          echo "IP VPS (Tailscale): ${TS_IP}"
          echo "Username VPS: runner"
          echo "Password VPS: ${SSH_PASS}"
          echo "------------------------------------------------------------"
          echo "To shell into panel container: docker exec -it panel sh"
          echo "============================================================"

      # =========================================================
      # 5. Keep Runner Alive 6h (Kode Anda)
      # =========================================================
      - name: Keep Alive 6h
        run: |
          echo "Runner sleeping for 6 hours..."
          sleep 6h

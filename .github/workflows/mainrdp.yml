name: Ptero-Panel + Wings + NodeJS (Nginx + PHP-FPM, No DB)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Install Docker
      run: |
        sudo apt update -y
        sudo apt install -y docker.io docker-compose curl jq

    - name: Setup Tailscale
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --auth-key "${TSKEY}" --hostname ghpanel --accept-routes
        TSIP=$(tailscale ip -4 | head -n1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Create Docker network
      run: docker network create ptero-net || true

    - name: Deploy Pterodactyl Panel (Nginx + PHP-FPM)
      run: |
        docker rm -f ptero_panel || true
        # Gunakan PHP-FPM + Nginx agar tidak 502
        docker run -d --name ptero_panel --network ptero-net \
          -p 8080:80 \
          -v /etc/pterodactyl:/var/www/html \
          -e NGINX_HOST=localhost \
          php:8.2-fpm

        # Jalankan Nginx container proxy ke PHP-FPM
        docker rm -f ptero_nginx || true
        docker run -d --name ptero_nginx --network ptero-net \
          -p 80:80 \
          -v /etc/pterodactyl:/var/www/html:ro \
          -v $PWD/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
          nginx:latest

    - name: Deploy Wings
      run: |
        docker rm -f wings || true
        docker run -d --name wings --network ptero-net \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v /etc/pterodactyl:/etc/pterodactyl \
          ghcr.io/pterodactyl/wings:latest \
          --config /etc/pterodactyl/config.yml

    - name: Deploy NodeJS Server
      run: |
        docker rm -f nodejs || true
        docker run -d --name nodejs --network ptero-net \
          -p 3000:3000 \
          -v $PWD/nodejs:/app \
          -w /app \
          node:16 \
          sh -c "npm install && node server.js"

    - name: Display Info
      run: |
        echo "Panel: http://localhost"
        echo "NodeJS Server: http://localhost:3000"
        echo "TAILSCALE IP: $TSIP"

    - name: Keep runner alive
      run: sleep 6h

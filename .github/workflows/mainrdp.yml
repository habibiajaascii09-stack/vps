name: Pterodactyl Docker (Light)

on:
  workflow_dispatch:

jobs:
  panel:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      - name: Prepare environment & Docker
        run: |
          sudo apt update -y
          sudo apt install -y ca-certificates curl gnupg lsb-release jq
          # Install Docker (safe script)
          curl -fsSL https://get.docker.com | sh
          # Ensure docker is usable (start dockerd if not active)
          if ! sudo docker info > /dev/null 2>&1; then
            sudo dockerd > /tmp/dockerd.log 2>&1 &
            for i in $(seq 1 20); do
              if sudo docker info > /dev/null 2>&1; then break; fi
              sleep 1
            done
          fi
          sudo docker version

      - name: Launch Pterodactyl Panel container (SQLite, basic)
        run: |
          ADMIN_EMAIL="ashifaja123@gmail.com"
          ADMIN_USER="admin"
          ADMIN_PASS=$(openssl rand -base64 12 | tr -dc 'A-Za-z0-9' | cut -c1-12)
          echo "Admin will be: ${ADMIN_USER} / ${ADMIN_PASS}"

          # Remove any previous container
          docker rm -f panel || true

          # Run panel image (bind to host 8080)
          docker run -d --name panel \
            -p 8080:80 \
            --env APP_ENV=production \
            --env APP_URL=http://127.0.0.1 \
            ghcr.io/pterodactyl/panel:latest || true

          # Wait for container filesystem to be ready
          for i in $(seq 1 40); do
            if docker exec panel sh -c "test -f /var/www/pterodactyl/artisan || test -f /var/www/html/artisan" > /dev/null 2>&1; then
              echo "Panel filesystem present."
              break
            fi
            echo "Waiting for panel container to be ready..."
            sleep 2
          done

          # Determine where artisan is located (common paths)
          if docker exec panel sh -c "test -f /var/www/pterodactyl/artisan" > /dev/null 2>&1; then
            ARTISAN="/var/www/pterodactyl/artisan"
            APP_DIR="/var/www/pterodactyl"
          else
            ARTISAN="/var/www/html/artisan"
            APP_DIR="/var/www/html"
          fi

          # Prepare env, key, migrate, and create admin (tolerant)
          docker exec panel sh -c "cd ${APP_DIR} && cp .env.example .env 2>/dev/null || true"
          docker exec panel sh -c "cd ${APP_DIR} && sed -i 's|APP_URL=.*|APP_URL=http://127.0.0.1|' .env || true"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan key:generate --force || true"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan migrate --force || true"

          # Try to create admin user (if command exists). tolerate failure.
          docker exec panel sh -c "cd ${APP_DIR} && php artisan p:user:make --email='${ADMIN_EMAIL}' --username='${ADMIN_USER}' --name-first='Admin' --name-last='User' --password='${ADMIN_PASS}' --admin=1 || true"

          # Print details to workflow log
          PUBLIC_IP=$(curl -s https://api.ipify.org || echo "127.0.0.1")
          echo "--------------------------------------------------"
          echo "PTERODACTYL PANEL (Docker) - READY (ephemeral runner)"
          echo "Access (host): http://${PUBLIC_IP}:8080"
          echo "Admin email : ${ADMIN_EMAIL}"
          echo "Admin user  : ${ADMIN_USER}"
          echo "Admin pass  : ${ADMIN_PASS}"
          echo "Container name: panel"
          echo "--------------------------------------------------"

          # Provide a simple command to shell into panel container
          echo "To open shell (locally or via SSH): docker exec -it panel sh"

      - name: Keep runner alive 6 hours
        run: |
          echo "Runner will sleep for 6 hours..."
          sleep 6h

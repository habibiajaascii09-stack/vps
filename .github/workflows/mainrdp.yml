name: Ptero Docker + Tailscale SSH (Stable)

on:
  workflow_dispatch:

jobs:
  setup:
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
    - name: Install Docker
      run: |
        sudo apt update -y
        curl -fsSL https://get.docker.com | sh

    - name: Install Tailscale + Enable SSH
      env:
        AUTHKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.gpg | sudo gpg --dearmor -o /usr/share/keyrings/tailscale.gpg
        echo "deb [signed-by=/usr/share/keyrings/tailscale.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" \
          | sudo tee /etc/apt/sources.list.d/tailscale.list

        sudo apt update -y
        sudo apt install -y tailscale

        sudo systemctl enable --now tailscaled
        sudo tailscale up --ssh --authkey="${AUTHKEY}" --hostname="ghrunner-${{ github.run_id }}" --accept-routes

    - name: Start MariaDB
      run: |
        docker rm -f db || true
        docker run -d --name db \
          --health-cmd="mysqladmin ping -h localhost -p'ptero123'" \
          --health-interval=5s --health-timeout=3s --health-retries=20 \
          -e MARIADB_ROOT_PASSWORD=rootpass \
          -e MARIADB_DATABASE=ptero \
          -e MARIADB_USER=ptero \
          -e MARIADB_PASSWORD=ptero123 \
          mariadb:10.6

    - name: Start Pterodactyl Panel (No Loop)
      run: |
        docker rm -f panel || true
        docker run -d --name panel \
          --link db:db \
          -p 8080:80 \
          -e DB_CONNECTION=mysql \
          -e DB_HOST=db \
          -e DB_PORT=3306 \
          -e DB_DATABASE=ptero \
          -e DB_USERNAME=ptero \
          -e DB_PASSWORD=ptero123 \
          ghcr.io/pterodactyl/panel:latest

        sleep 20

        ADMIN_PASS=$(openssl rand -hex 6)
        docker exec panel sh -c "cd /app && cp .env.example .env && php artisan key:generate --force && php artisan migrate --force"
        docker exec panel sh -c "cd /app && php artisan p:user:make --username=admin --email=test@example.com --name-first=Admin --name-last=User --password=${ADMIN_PASS} --admin=1"

        TS_IP=$(tailscale ip -4)
        echo "=============================="
        echo "Tailscale SSH: ssh runner@${TS_IP}"
        echo "Pterodactyl: http://${TS_IP}:8080"
        echo "Admin pass: ${ADMIN_PASS}"
        echo "=============================="

    - name: Keep alive
      run: sleep 6h

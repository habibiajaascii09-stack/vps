name: Deploy Pterodactyl Panel

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Tailscale
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --auth-key "${TSKEY}" --hostname ghpanel --accept-routes
        TSIP=$(tailscale ip -4 | head -n1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Create Docker network
      run: docker network create ptero-net || true

    - name: Create nginx.conf automatically
      run: |
        mkdir -p $PWD
        {
          echo "server {";
          echo "    listen 80;";
          echo "    server_name _;";
          echo "    root /var/www/html/public;";
          echo "    index index.php index.html;";
          echo "    location / { try_files \$uri /index.php?\$query_string; }";
          echo "    location ~ \\.php\$ {";
          echo "        fastcgi_pass ptero_panel:9000;";
          echo "        include fastcgi_params;";
          echo "        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;";
          echo "    }";
          echo "}";
        } > $PWD/nginx.conf

    - name: Start MariaDB
      run: |
        docker run -d --name ptero_db --network ptero-net \
          -e MYSQL_DATABASE=panel \
          -e MYSQL_USER=ptero \
          -e MYSQL_PASSWORD=StrongPass123 \
          -e MYSQL_ROOT_PASSWORD=RootPass123 \
          mariadb:10.6

    - name: Start Pterodactyl Panel
      run: |
        docker run -d --name ptero_panel --network ptero-net \
          -e DB_HOST=ptero_db \
          -e DB_PORT=3306 \
          -e DB_DATABASE=panel \
          -e DB_USERNAME=ptero \
          -e DB_PASSWORD=StrongPass123 \
          -v panel_data:/var/www/html \
          -p 9000:9000 \
          ghcr.io/pterodactyl/panel:latest

    - name: Wait DB connection + migrate
      run: |
        echo "Waiting until panel can connect to DB..."
        for i in {1..60}; do
          if docker exec ptero_panel php artisan migrate --force 2>/dev/null; then
            echo "Migration DONE!"
            exit 0
          fi
          echo "($i) DB not ready..."
          sleep 5
        done
        echo "ERROR: Database never connected"
        exit 1

    - name: Create Admin Account
      run: |
        docker exec ptero_panel php artisan p:user:create \
          --email="ashifaja123@gmail.com" \
          --username="ashifaja123" \
          --name-first="Ashif" \
          --name-last="Aja" \
          --password="Maesaroh" \
          --admin=1 \
          --no-interaction || true

    - name: Start Nginx
      run: |
        docker run -d --name panel_nginx --network ptero-net \
          -p 80:80 \
          -v $PWD/nginx.conf:/etc/nginx/conf.d/default.conf \
          -v panel_data:/var/www/html \
          nginx:latest

    - name: Display Panel Info
      run: |
        echo ""
        echo "============================================="
        echo " PTERODACTYL PANEL DEPLOYED SUCCESSFULLY"
        echo "============================================="
        echo "LOGIN PANEL : http://$TSIP"
        echo "EMAIL       : ashifaja123@gmail.com"
        echo "USERNAME    : ashifaja123"
        echo "PASSWORD    : Maesaroh"
        echo "============================================="
        echo "LOG PANNEL (last 40 lines):"
        docker logs --tail 40 ptero_panel || true
        echo ""
        echo "LOG NGINX (last 40 lines):"
        docker logs --tail 40 panel_nginx || true
        echo ""
        echo "LOG MARIADB (last 40 lines):"
        docker logs --tail 40 ptero_db || true
        echo ""

    - name: Sleep 6 Hours
      run: sleep 21600

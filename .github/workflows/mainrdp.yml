name: Ptero-Panel + Wings (Tailscale)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Update & install dependencies
      run: |
        sudo apt update -y
        sudo apt install -y docker.io curl jq net-tools

    - name: Setup Tailscale
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --auth-key "${TSKEY}" --hostname ghpanel --accept-routes
        TSIP=$(tailscale ip -4 | head -n 1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Create Docker network
      run: docker network create ptero-net || true

    - name: Deploy Pterodactyl Panel
      run: |
        docker rm -f ptero_panel || true
        docker run -d --name ptero_panel --network ptero-net \
          -p 8080:80 \
          ghcr.io/pterodactyl/panel:latest

    - name: Wait for artisan
      id: wait_panel
      run: |
        for i in $(seq 1 120); do
          if docker exec ptero_panel test -f /var/www/pterodactyl/artisan >/dev/null 2>&1; then
            echo "dir=/var/www/pterodactyl" >> $GITHUB_OUTPUT
            exit 0
          fi
          echo "Waiting ($i)"
          sleep 3
        done
        echo "Artisan not found"
        exit 1

    - name: Configure .env
      run: |
        DIR=${{ steps.wait_panel.outputs.dir }}
        docker exec ptero_panel cp ${DIR}/.env.example ${DIR}/.env
        docker exec ptero_panel sed -i \
          -e "s/APP_URL=.*/APP_URL=https:\/\/panelasip.my.id/" \
          -e "s/APP_TIMEZONE=.*/APP_TIMEZONE=Asia\/Jakarta/" \
          -e "s/DB_HOST=.*/DB_HOST=pterodb/" \
          ${DIR}/.env

    - name: Generate APP_KEY & migrate
      run: |
        DIR=${{ steps.wait_panel.outputs.dir }}
        docker exec ptero_panel php ${DIR}/artisan key:generate --force
        docker exec ptero_panel php ${DIR}/artisan migrate --force

    - name: Create admin user
      run: |
        DIR=${{ steps.wait_panel.outputs.dir }}
        docker exec ptero_panel php ${DIR}/artisan p:user:create \
          --email="ashifaja123@gmail.com" \
          --username="admin" \
          --name-first="Admin" \
          --name-last="Panel" \
          --password="passwordku123" \
          --admin=1 \
          --no-interaction || true

    - name: Auto SSL
      run: |
        docker exec ptero_panel bash -c "cd /var/www/pterodactyl && php artisan p:environment:setup"
        docker exec ptero_panel bash -c "cd /var/www/pterodactyl && php artisan p:environment:mail"
        docker exec ptero_panel bash -c "cd /var/www/pterodactyl && php artisan p:environment:database"
        docker exec ptero_panel bash -c "cd /var/www/pterodactyl && php artisan p:environment:queue"
        docker exec ptero_panel bash -c "cd /var/www/pterodactyl && php artisan p:environment:mail"
        docker exec ptero_panel bash -c "cd /var/www/pterodactyl && php artisan p:environment:ssl --email ashifaja123@gmail.com --domain panelasip.my.id"

    - name: Deploy Wings (Tailscale private IP)
      run: |
        docker rm -f wings || true
        docker run -d --name wings --network ptero-net \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v /etc/pterodactyl:/etc/pterodactyl \
          ghcr.io/pterodactyl/wings:latest \
          --config /etc/pterodactyl/config.yml

    - name: Display Panel Info
      run: |
        echo "PANEL: https://panelasip.my.id"
        echo "LOGIN EMAIL : ashifaja123@gmail.com"
        echo "LOGIN PASS  : passwordku123"
        echo "TAILSCALE IP: $TSIP"

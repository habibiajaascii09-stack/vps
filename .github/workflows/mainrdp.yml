name: Ptero Docker + Tailscale Lite

on:
  workflow_dispatch:

jobs:
  ptero_setup:
    name: Pterodactyl Setup Runner
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # =========================================================
      # 0. Install Docker
      # =========================================================
      - name: Install Docker
        run: |
          echo "Menginstal Docker..."
          sudo apt update -y
          curl -fsSL https://get.docker.com | sh
          sudo systemctl start docker || true

      # =========================================================
      # 1. Add Tailscale Repository
      # =========================================================
      - name: Add Tailscale Repository and Update Apt
        run: |
          echo "Menambahkan repositori Tailscale..."
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/tailscale-archive-keyring.gpg arch=amd64] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y

      # =========================================================
      # 2. Install & Start Tailscale (Automatic Auth Key)
      # =========================================================
      - name: Install & Start Tailscale
        env:
          TAILSCALE_KEY: ${{ secrets.TAILSCALE_KEY }}
        run: |
          echo "Menginstal Tailscale..."
          sudo apt install -y tailscale

          echo "Menjalankan Tailscale dengan auth key..."
          sudo tailscale up --authkey="${TAILSCALE_KEY}" --hostname=gh-runner-${{ github.run_id }} --accept-routes

          sleep 5
          TS_IP=$(tailscale ip -4 2>/dev/null || true)

          if [ -n "$TS_IP" ]; then
            echo "✅ Tailscale IP berhasil didapatkan: $TS_IP"
          else
            echo "❌ Gagal mendapatkan IP Tailscale"
          fi

      # =========================================================
      # 3. Start MariaDB Container
      # =========================================================
      - name: Start MariaDB
        run: |
          echo "Menjalankan MariaDB Container..."
          docker rm -f db || true
          docker run -d --name db \
            -e MARIADB_ROOT_PASSWORD=rootpass \
            -e MARIADB_DATABASE=ptero \
            -e MARIADB_USER=ptero \
            -e MARIADB_PASSWORD=ptero123 \
            mariadb:10.6

      # =========================================================
      # 4. Start Pterodactyl Panel + Init DB + Create Admin
      # =========================================================
      - name: Start Panel + init DB + create admin
        run: |
          ADMIN_PASS=$(openssl rand -hex 6)
          docker rm -f panel || true
          echo "Menjalankan Pterodactyl Panel Container..."
          docker run -d --name panel \
            --link db:db \
            -p 8080:80 \
            -e DB_CONNECTION=mysql \
            -e DB_HOST=db \
            -e DB_PORT=3306 \
            -e DB_DATABASE=ptero \
            -e DB_USERNAME=ptero \
            -e DB_PASSWORD=ptero123 \
            ghcr.io/pterodactyl/panel:latest || true

          # wait filesystem & artisan availability
          for i in $(seq 1 60); do
            if docker exec panel sh -c "test -f /var/www/pterodactyl/artisan" >/dev/null 2>&1 || docker exec panel sh -c "test -f /var/www/html/artisan" >/dev/null 2>&1; then
              echo "Panel filesystem ready."
              break
            fi
            echo "Waiting for panel container..."
            sleep 2
          done

          # find artisan path and app dir
          if docker exec panel sh -c "test -f /var/www/pterodactyl/artisan" >/dev/null 2>&1; then
            APP_DIR="/var/www/pterodactyl"
          else
            APP_DIR="/var/www/html"
          fi

          # ensure .env and key, migrate, create admin
          docker exec panel sh -c "cd ${APP_DIR} && cp .env.example .env 2>/dev/null || true"
          docker exec panel sh -c "cd ${APP_DIR} && sed -i 's|APP_URL=.*|APP_URL=http://127.0.0.1:8080|' .env || true"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan key:generate --force || true"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan migrate --force || true"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan p:user:make --email='ashifaja123@gmail.com' --username='admin' --name-first='Admin' --name-last='User' --password='${ADMIN_PASS}' --admin=1 || true"

          # capture Tailscale IP & public IP
          TS_IP=$(tailscale ip -4 2>/dev/null || true)
          PUBLIC_IP=$(curl -s https://api.ipify.org || echo "127.0.0.1")

          echo "===================================="
          echo "Pterodactyl Panel (Docker) READY"
          if [ -n "$TS_IP" ]; then
            echo "Akses via Tailscale: http://${TS_IP}:8080"
          fi
          echo "Akses via Host: http://${PUBLIC_IP}:8080"
          echo "Admin user : admin"
          echo "Admin pass : ${ADMIN_PASS}"
          echo "DB user    : ptero  DB pass: ptero123"
          echo "===================================="
          echo "To shell into panel container: docker exec -it panel sh"

      # =========================================================
      # 5. Keep Runner Alive 6h
      # =========================================================
      - name: Keep Alive 6h
        run: |
          echo "Runner sleeping for 6 hours..."
          sleep 6h

name: Tailscale Runner HP Version (Pterodactyl) - ULTIMATE FIX

on:
  workflow_dispatch:
    inputs:
      tailscale_auth_key:
        description: 'Kunci Otorisasi Tailscale'
        required: true
        default: ''
      runner_password:
        description: 'Password untuk User SSH Runner (Perhatian: terlihat di log)'
        required: true
        default: 'vpspass123' 

jobs:
  temporary-vps-access:
    runs-on: ubuntu-latest
    timeout-minutes: 350 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4
          
      # 1. Setup Tailscale & SSH (Tidak diubah, sudah stabil)
      - name: Setup Tailscale dan SSH
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ github.event.inputs.tailscale_auth_key }} 
          hostname: github-runner-${{ github.run_id }}
          
      - name: Install OpenSSH Server dan Atur Password
        run: |
          sudo apt update
          sudo apt install -y openssh-server
          echo -e "${{ github.event.inputs.runner_password }}\n${{ github.event.inputs.runner_password }}" | sudo passwd runner

      # 2. Install Docker dan Deploy Pterodactyl (Tidak diubah, sudah stabil)
      - name: âš™ï¸ Install Docker dan Docker Compose
        run: |
          sudo apt install -y apt-transport-https ca-certificates curl gnupg lsb-release
          curl -fsSL https://download.docker.com/linux/ubuntu/gpg | sudo gpg --dearmor -o /usr/share/keyrings/docker-archive-keyring.gpg
          echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/docker-archive-keyring.gpg] https://download.docker.com/linux/ubuntu $(lsb_release -cs) stable" | sudo tee /etc/apt/sources.list.d/docker.list > /dev/null
          sudo apt update
          sudo apt install -y docker-ce docker-ce-cli containerd.io docker-compose-plugin

      - name: ðŸš€ Deploy Pterodactyl Panel (Expose Port 8080)
        run: |
          mkdir -p /home/runner/pterodactyl
          cd /home/runner/pterodactyl
          wget -q -O docker-compose.yml https://raw.githubusercontent.com/pterodactyl/panel/develop/docker-compose.yml
          cp .env.example .env
          
          # Modify docker-compose.yml: Ubah ports '80:80' menjadi '8080:80' untuk panel service
          sudo sed -i '/ports:/!b;n;/ - 80:80/c\      - 8080:80' docker-compose.yml
          
          echo "Menjalankan container Pterodactyl, mengekspos ke port 8080 host..."
          sudo docker compose up -d

      # 3. Setup Nginx (DI PERBAIKI)
      - name: ðŸŒ Setup Nginx Proxy ke 8080
        run: |
          TS_IP=$(tailscale ip -4)
          echo "Tailscale IP Ditemukan: $TS_IP"
          
          # 1. Instal Nginx
          sudo apt install -y nginx

          # 2. Hapus default config
          sudo rm /etc/nginx/sites-enabled/default
          
          # 3. Buat konfigurasi Nginx untuk Proxy Terbalik
          # Konfigurasi ini HANYA menjadi proxy, tidak mencoba melayani file statis
          sudo tee /etc/nginx/sites-available/pterodactyl.conf > /dev/null <<EOF
server {
    listen 80;
    server_name $TS_IP;

    location / {
        # PROXY_PASS BARU: Nginx meneruskan SEMUA permintaan ke port 8080 (container Pterodactyl)
        proxy_pass http://127.0.0.1:8080;
        
        # Header proxy standar
        proxy_set_header Host \$host;
        proxy_set_header X-Real-IP \$remote_addr;
        proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto \$scheme;
        
        # Tambahkan timeout untuk mencegah kegagalan karena lambat start
        proxy_read_timeout 300s;
        proxy_connect_timeout 75s;
    }
}
EOF
          # 4. Aktifkan konfigurasi Nginx dan restart
          sudo ln -s /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/
          sudo systemctl restart nginx
          echo "Pterodactyl siap diakses melalui Nginx di IP Tailscale: $TS_IP"
          echo "RUNNER_IP=$TS_IP" >> $GITHUB_ENV # Simpan IP Tailscale

      # 4. Mendapatkan IP Address dan Menahan Runner (Tidak diubah)
      - name: Get Connection Information
        run: |
          ip_address=${{ env.RUNNER_IP }}
          echo "### âœ… Runner Siap diakses via Web! (http://${ip_address})" >> $GITHUB_STEP_SUMMARY
          echo "### âš ï¸ PENTING: Lakukan setup Pterodactyl (migrate, user:make) via SSH." >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ **Akses Web**: http://${ip_address}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ”‘ **Akses SSH**: ssh runner@${ip_address} (Pass: ${{ github.event.inputs.runner_password }})" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY

      - name: Hold Job and Wait for Timeout
        run: |
          sleep 350m
          
      - name: Job Finished
        if: always()
        run: echo "Job selesai. Runner telah dimatikan."

name: VPS and Setup Panel

on:
  workflow_dispatch:
    inputs:
      tailscale_authkey:
        description: 'Tailscale Auth Key'
        required: true
        default: 'tskey-auth-~~~~~~~'

jobs:
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Install Tailscale
        run: |
          curl -fsSL https://tailscale.com/install.sh | sh
          sudo tailscale up --authkey ${{ inputs.tailscale_authkey }} --hostname github-runner

      - name: Get Tailscale IP
        id: tailscale_ip
        run: |
          echo "TAILSCALE_IP=$(tailscale ip -4)" >> $GITHUB_ENV

      - name: Install dependencies
        run: |
          sudo apt update
          sudo apt install -y curl wget gnupg2 software-properties-common

      - name: Install Nginx
        run: |
          sudo apt install -y nginx
          sudo systemctl start nginx
          sudo systemctl enable nginx

      - name: Configure Nginx for Pterodactyl Panel
        run: |
          sudo tee /etc/nginx/sites-available/panel.panelasip.my.id > /dev/null <<EOF
          server {
              listen 80;
              server_name panel.panelasip.my.id;
              location / {
                  proxy_pass http://localhost:8080;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
          }
          EOF
          sudo ln -s /etc/nginx/sites-available/panel.panelasip.my.id /etc/nginx/sites-enabled/
          sudo nginx -t
          sudo systemctl reload nginx

      - name: Configure Nginx for Pterodactyl Node
        run: |
          sudo tee /etc/nginx/sites-available/node.panel.my.id > /dev/null <<EOF
          server {
              listen 80;
              server_name node.panel.my.id;
              location / {
                  proxy_pass http://localhost:8081;
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
              }
          }
          EOF
          sudo ln -s /etc/nginx/sites-available/node.panel.my.id /etc/nginx/sites-enabled/
          sudo nginx -t
          sudo systemctl reload nginx

      - name: Install Docker (for Pterodactyl)
        run: |
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo systemctl start docker
          sudo systemctl enable docker

      - name: Install Pterodactyl Panel
        run: |
          curl -sSL https://pterodactyl-installer.sebastian-lehrbach.de/ | sudo bash -s -- --panel-only --email ashifaja123@gmail.com --password ashifaja123 --hostname panel.panelasip.my.id --port 8080

      - name: Install Pterodactyl Wings (Node)
        run: |
          curl -sSL https://pterodactyl-installer.sebastian-lehrbach.de/ | sudo bash -s -- --wings-only --panel-url https://panel.panelasip.my.id --token YOUR_WINGS_TOKEN --hostname node.panel.my.id --port 8081

      - name: Output Information
        run: |
          echo "IP VPS: ${{ env.TAILSCALE_IP }}"
          echo "VPS Password: (Default Ubuntu runner, no password set)"
          echo "Akun Panel: ashifaja123@gmail.com"
          echo "Password Panel: ashifaja123"

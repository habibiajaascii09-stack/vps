name: Deploy VPS Sementara via SSH dan Tailscale

# Trigger workflow secara manual dengan input
on:
  workflow_dispatch:
    inputs:
      # Kunci Otorisasi Tailscale dimasukkan di sini (seperti di gambar)
      tailscale_auth_key:
        description: 'Kunci Otorisasi Tailscale'
        required: true
        default: ''

jobs:
  temporary-vps-access:
    runs-on: ubuntu-latest
    # Timeout disetel ke 350 menit (maksimum yang diizinkan untuk GitHub runner)
    timeout-minutes: 350 

    steps:
      - name: â³ Siapkan Lingkungan dan Install Tailscale
        run: |
          echo "Memulai instalasi Tailscale dan SSH..."
          
          # Perbarui dan Install Kebutuhan Dasar
          sudo apt update
          sudo apt install -y curl wget openssh-server gpg

          # --- INSTALASI TAILSCALE MENGGUNAKAN METODE MANUAL YANG STABIL ---
          # 1. Unduh Kunci Publik GPG
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.key | \
          sudo gpg --dearmor -o /usr/share/keyrings/tailscale-archive-keyring.gpg
          
          # 2. Tambahkan Repositori
          echo "deb [signed-by=/usr/share/keyrings/tailscale-archive-keyring.gpg] https://pkgs.tailscale.com/stable/ubuntu jammy main" | \
          sudo tee /etc/apt/sources.list.d/tailscale.list > /dev/null
          
          # 3. Instal Tailscale
          sudo apt update
          sudo apt install -y tailscale

          # Otentikasi Tailscale menggunakan Kunci dari Workflow Input
          echo "Melakukan Otentikasi Tailscale dengan Kunci dari Input..."
          sudo tailscale up --authkey=${{ github.event.inputs.tailscale_auth_key }} --ssh
          
          # Dapatkan IP Tailscale dan simpan sebagai variabel lingkungan
          TS_IP=$(tailscale ip -4)
          echo "RUNNER_IP=$TS_IP" >> $GITHUB_ENV

      - name: ðŸ” Buat User dan Password SSH
        run: |
          # Pengaturan user dan pembuatan password acak
          VPS_USER="vpsuser"
          # Membuat password acak
          VPS_PASSWORD=$(cat /dev/urandom | tr -dc 'a-zA-Z0-9' | fold -w 12 | head -n 1)
          
          # Membuat user baru dan mengatur password
          sudo adduser --disabled-password --gecos "" $VPS_USER
          echo "$VPS_USER:$VPS_PASSWORD" | sudo chpasswd
          sudo usermod -aG sudo $VPS_USER
          
          # Catat password untuk output log
          echo "VPS_PASSWORD=$VPS_PASSWORD" >> $GITHUB_ENV

      - name: ðŸ”‘ Catat Informasi Akses dan Tutorial SSH
        run: |
          echo "================================================="
          echo "      âœ¨ Informasi Akses VPS (SSH) Tersedia! âœ¨"
          echo "================================================="
          echo "Alamat IP Tailscale: ${{ env.RUNNER_IP }}"
          echo "Username SSH: **vpsuser**"
          echo "Password SSH: **${{ env.VPS_PASSWORD }}**"
          echo ""
          echo "ðŸ“¢ Tutorial Akses (Menggunakan Juicessh atau SSH Client lain):"
          echo "1. Pastikan perangkat Anda terinstal **Tailscale** dan ter-Otorisasi ke jaringan yang sama."
          echo "2. Buka klien SSH Anda."
          echo "3. Buat koneksi SSH baru:"
          echo "   - **Host/Alamat**: ${{ env.RUNNER_IP }}"
          echo "   - **Port**: 22"
          echo "   - **Username**: vpsuser"
          echo "   - **Password**: ${{ env.VPS_PASSWORD }}"
          echo "================================================="
          
      - name: ðŸ•’ Jaga Runner Tetap Aktif Selama 6 Jam
        run: |
          echo "Job akan berjalan selama 350 menit (sekitar 5 jam 50 menit)."
          echo "Waktu mulai: $(date)"
          # Menjaga runner tetap berjalan
          sleep 350m
          
      - name: Job Finished
        if: always()
        run: echo "Job selesai. Runner telah dimatikan."

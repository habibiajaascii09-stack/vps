# .github/workflows/pterodactyl_install.yml

name: Instalasi Pterodactyl Panel via Docker + Tailscale

# Workflow hanya dapat dipicu secara manual
on:
  workflow_dispatch: 

jobs:
  pterodactyl_setup:
    runs-on: ubuntu-latest
    permissions:
      contents: read
    
    steps:
      - name: Checkout Kode Repositori
        uses: actions/checkout@v4

      # =================================================================
      # A. SETUP DOCKER & DOCKER COMPOSE
      # =================================================================
      - name: Instalasi Docker dan Dependencies
        run: |
          echo "Memperbarui sistem dan menginstal Docker..."
          sudo apt update
          sudo apt install -y docker.io docker-compose
          sudo systemctl start docker
          sudo systemctl enable docker
          # Menambahkan user ke grup docker agar bisa menjalankan docker tanpa sudo
          sudo usermod -aG docker $USER
          echo "Docker siap digunakan."

      # =================================================================
      # B. SETUP TAILSCALE (Akses Jaringan Aman)
      # =================================================================
      - name: Setup dan Login Tailscale
        uses: tailscale/github-action@v2
        with:
          # Menggunakan pre-auth key dari GitHub Secret
          authkey: ${{ secrets.TAILSCALE_AUTH_KEY }} 
          
      - name: Cetak Detail Akses Tailscale (Aman di Log)
        id: tailscale_info
        run: |
          echo "================================================="
          echo "  DETAIL AKSES TAILSCALE"
          echo "================================================="
          HOSTNAME=$(hostname)
          IP_ADDR=$(tailscale ip -4)
          echo "1. Hostname Mesin (MagicDNS): -> ${HOSTNAME}.[tailnet-name].ts.net"
          echo "2. Alamat IP Tailscale (Aman): -> ${IP_ADDR}"
          echo "================================================="
          echo "::set-output name=tailscale_ip::${IP_ADDR}" # Menyimpan IP untuk digunakan nanti
          
      # =================================================================
      # C. SETUP SERVER SSH (Akses Debugging via JuiceSSH)
      # =================================================================
      - name: Instalasi OpenSSH Server dan Konfigurasi Kunci
        env:
          PUBLIC_KEY: ${{ secrets.SSH_PUBLIC_KEY }} # Ambil Public Key dari Secret
        run: |
          echo "Menginstal OpenSSH Server..."
          sudo apt install -y openssh-server
          sudo systemctl start ssh
          sudo systemctl enable ssh
          
          # Konfigurasi Kunci
          mkdir -p ~/.ssh
          echo "$PUBLIC_KEY" >> ~/.ssh/authorized_keys
          chmod 700 ~/.ssh
          chmod 600 ~/.ssh/authorized_keys
          
          echo "SSH siap. Akses sebagai user: 'runner' menggunakan Private Key Anda."

      # =================================================================
      # D. INSTALASI PTERODACTYL PANEL via DOCKER
      # =================================================================
      - name: Menjalankan Container Pterodactyl Panel
        run: |
          echo "Menjalankan Pterodactyl Panel Container..."
          
          # Menjalankan Panel Container di port 8080 (untuk diakses Nginx)
          docker run -d --name panel \
          -p 8080:80 \
          -p 8081:443 \
          --env-file <(echo 'APP_URL=http://localhost') \
          --restart=always \
          ghcr.io/pterodactyl/panel:latest
          
          echo "Pterodactyl Panel berjalan di port 8080 (HTTP) di dalam container."
          sleep 15 # Beri waktu container untuk inisialisasi

      # =================================================================
      # E. MEMBUAT AKUN ADMINISTRATOR PANEL
      # =================================================================
      - name: Membuat Akun Administrator Panel
        run: |
          echo "Menunggu Panel Inisialisasi (15 detik lagi)..."
          sleep 15
          
          # Perintah untuk membuat user admin (Menggunakan data yang Anda berikan)
          docker exec panel php artisan p:user:make \
              --email="ashifaja123@gmail.com" \
              --username="ROCKWATER" \
              --name-first="ashif" \
              --name-last="aja123" \
              --password="Maesaroh" \
              --admin=1
              
          echo "================================================="
          echo "  AKUN ADMIN PTERODACTYL BERHASIL DIBUAT"
          echo "  Username: ROCKWATER"
          echo "  Password: Maesaroh (WAJIB GANTI SETELAH LOGIN!)"
          echo "================================================="

      # =================================================================
      # F. SETUP NGINX (Reverse Proxy)
      # =================================================================
      - name: Instalasi Nginx dan Konfigurasi Reverse Proxy
        run: |
          echo "Menginstal Nginx..."
          sudo apt install -y nginx
          
          # Membuat file konfigurasi Nginx untuk Pterodactyl
          sudo tee /etc/nginx/sites-available/pterodactyl.conf > /dev/null <<EOT
          server {
              listen 80 default_server;
              listen [::]:80 default_server;
              server_name _; 
              
              location / {
                  # Proxy ke Container Pterodactyl di port 8080
                  proxy_pass http://127.0.0.1:8080; 
                  proxy_set_header Host \$host;
                  proxy_set_header X-Real-IP \$remote_addr;
                  proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                  proxy_set_header X-Forwarded-Proto \$scheme;
                  proxy_read_timeout 900;
              }
          }
          EOT

          # Mengaktifkan konfigurasi dan membersihkan
          sudo ln -s /etc/nginx/sites-available/pterodactyl.conf /etc/nginx/sites-enabled/
          sudo rm -f /etc/nginx/sites-enabled/default
          
          echo "Memuat ulang Nginx..."
          sudo systemctl reload nginx
          
      # =================================================================
      # G. MENJAGA RUNNER TETAP HIDUP (Akses Maksimal 6 Jam)
      # =================================================================
      - name: Runner Sleep 6 Jam
        run: |
          IP_ADDR_FINAL=${{ steps.tailscale_info.outputs.tailscale_ip }}
          echo "Instalasi SELESAI. Runner akan tidur selama 6 jam."
          echo "Anda sekarang dapat mengakses Panel Web dan SSH:"
          echo "Web Akses: http://${IP_ADDR_FINAL}/"
          echo "SSH Akses: ssh runner@${IP_ADDR_FINAL}"
          sleep 6h
          echo "Job selesai / dibatalkan oleh GitHub setelah 6 jam."

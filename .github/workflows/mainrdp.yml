name: CloudRDP + Pterodactyl + Tailscale

on:
  workflow_dispatch:

jobs:
  rdp:
    runs-on: ubuntu-latest

    steps:
    - name: Update system
      run: sudo apt update -y

    - name: Install XFCE + XRDP
      run: |
        sudo apt install xfce4 xfce4-goodies xrdp -y
        sudo adduser ubuntu xrdp
        sudo systemctl enable xrdp
        sudo systemctl start xrdp
        echo "ubuntu:Admin123" | sudo chpasswd

    - name: Install Docker
      run: |
        curl -fsSL https://get.docker.com | sh
        sudo usermod -aG docker $USER

    - name: Create ptero network
      run: docker network create ptero-net || true

    - name: Run MariaDB
      run: |
        docker rm -f mariadb || true
        docker run -d --name mariadb --network ptero-net \
          -e MARIADB_ROOT_PASSWORD=root \
          -e MARIADB_DATABASE=panel \
          -e MARIADB_USER=ptero \
          -e MARIADB_PASSWORD=ptero \
          mariadb

    - name: Start Panel
      run: |
        docker rm -f ptero_panel || true
        docker run -d --name ptero_panel --network ptero-net \
          -p 8080:80 \
          ghcr.io/pterodactyl/panel:latest

    - name: Wait for Panel filesystem
      run: |
        for i in {1..120}; do
          if docker exec ptero_panel test -f /var/www/pterodactyl/artisan; then
            echo "DIR=/var/www/pterodactyl" >> $GITHUB_ENV
            exit 0
          fi
          sleep 3
        done
        exit 1

    - name: Generate .env in panel
      run: |
        APP_URL="http://dummy.local"
        docker exec ptero_panel sh -c "echo APP_ENV=production > \$DIR/.env"
        docker exec ptero_panel sh -c "echo APP_DEBUG=false >> \$DIR/.env"
        docker exec ptero_panel sh -c "echo APP_URL=\$APP_URL >> \$DIR/.env"
        docker exec ptero_panel sh -c "echo DB_HOST=mariadb >> \$DIR/.env"
        docker exec ptero_panel sh -c "echo DB_PORT=3306 >> \$DIR/.env"
        docker exec ptero_panel sh -c "echo DB_DATABASE=panel >> \$DIR/.env"
        docker exec ptero_panel sh -c "echo DB_USERNAME=ptero >> \$DIR/.env"
        docker exec ptero_panel sh -c "echo DB_PASSWORD=ptero >> \$DIR/.env"

    - name: Install Panel
      run: |
        docker exec ptero_panel php /var/www/pterodactyl/artisan migrate --force
        docker exec ptero_panel php /var/www/pterodactyl/artisan db:seed --force

    - name: Create admin user
      run: |
        docker exec ptero_panel php /var/www/pterodactyl/artisan p:user:make \
          --email="ashifaja123@gmail.com" \
          --username="admin" \
          --name-first="Admin" \
          --name-last="User" \
          --password="admin123" \
          --admin=1 \
          --no-interaction

    - name: Install Wings
      run: |
        docker run -d --name wings --network ptero-net \
          --privileged \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -p 8081:8080 \
          ghcr.io/pterodactyl/wings:latest

    - name: Install Tailscale
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey=${{ secrets.TAILSCALE_AUTHKEY }} --ssh

    - name: Show Tailscale IP + ports
      run: |
        sleep 6
        IP=$(tailscale ip -4)
        echo "================================="
        echo "     ðŸŽ‰ SYSTEM READY ðŸŽ‰"
        echo "================================="
        echo "Panel  : http://$IP:8080"
        echo "RDP    : $IP:3389"
        echo "User   : ubuntu"
        echo "Pass   : Admin123"
        echo "================================="

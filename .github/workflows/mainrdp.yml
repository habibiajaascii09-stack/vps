name: Ptero Docker + Tailscale + SSH Lite

on:
  workflow_dispatch:

jobs:
  ptero_setup:
    name: Pterodactyl Runner
    runs-on: ubuntu-latest
    timeout-minutes: 360

    steps:
      # =========================================================
      # 0. Install Docker
      # =========================================================
      - name: Install Docker
        run: |
          echo "Menginstal Docker..."
          sudo apt update -y
          curl -fsSL https://get.docker.com | sh
          sudo systemctl start docker || true

      # =========================================================
      # 1. Add Tailscale Repo
      # =========================================================
      - name: Add Tailscale repo
        run: |
          sudo mkdir -p /etc/apt/keyrings
          curl -fsSL https://pkgs.tailscale.com/stable/ubuntu/jammy.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/tailscale-archive-keyring.gpg
          echo "deb [signed-by=/etc/apt/keyrings/tailscale-archive-keyring.gpg arch=amd64] https://pkgs.tailscale.com/stable/ubuntu jammy main" | sudo tee /etc/apt/sources.list.d/tailscale.list >/dev/null
          sudo apt update -y

      # =========================================================
      # 2. Install + Start Tailscale
      # =========================================================
      - name: Start Tailscale
        env:
          TAILSCALE_KEY: ${{ secrets.TAILSCALE_KEY }}
        run: |
          sudo apt install -y tailscale
          sudo tailscale up --authkey="${TAILSCALE_KEY}" --hostname=gh-${{ github.run_id }} --accept-routes
          sleep 3
          TS_IP=$(tailscale ip -4 || true)
          echo "Tailscale IP: $TS_IP"

      # =========================================================
      # 3. Start MariaDB
      # =========================================================
      - name: Start MariaDB
        run: |
          docker rm -f db || true
          docker run -d --name db \
            -e MARIADB_ROOT_PASSWORD=rootpass \
            -e MARIADB_DATABASE=ptero \
            -e MARIADB_USER=ptero \
            -e MARIADB_PASSWORD=ptero123 \
            mariadb:10.6

      # =========================================================
      # 4. Start Pterodactyl Panel
      # =========================================================
      - name: Start Panel
        run: |
          ADMIN_PASS=$(openssl rand -hex 4)
          docker rm -f panel || true

          docker run -d --name panel \
            --link db:db \
            -p 8080:80 \
            -e DB_CONNECTION=mysql \
            -e DB_HOST=db \
            -e DB_PORT=3306 \
            -e DB_DATABASE=ptero \
            -e DB_USERNAME=ptero \
            -e DB_PASSWORD=ptero123 \
            -e CACHE_DRIVER=file \
            -e SESSION_DRIVER=file \
            -e QUEUE_DRIVER=sync \
            ghcr.io/pterodactyl/panel:latest

          sleep 10

          # detect artisan path
          if docker exec panel sh -c "test -f /var/www/pterodactyl/artisan"; then
            APP_DIR="/var/www/pterodactyl"
          else
            APP_DIR="/var/www/html"
          fi

          # Init panel
          docker exec panel sh -c "cd ${APP_DIR} && cp .env.example .env"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan key:generate --force"
          docker exec panel sh -c "cd ${APP_DIR} && php artisan migrate --force"

          docker exec panel sh -c "cd ${APP_DIR} && php artisan p:user:make \
            --email='admin@example.com' \
            --username='admin' \
            --name-first='Admin' \
            --name-last='User' \
            --password='${ADMIN_PASS}' \
            --admin=1"

          TS_IP=$(tailscale ip -4 || true)
          PUBLIC_IP=$(curl -s https://api.ipify.org || echo "N/A")

          echo "===================================="
          echo " Pterodactyl Panel READY"
          echo " Access via Tailscale: http://${TS_IP}:8080"
          echo " Access via Public IP: http://${PUBLIC_IP}:8080"
          echo ""
          echo " Admin user : admin"
          echo " Admin pass : ${ADMIN_PASS}"
          echo " DB: ptero / ptero123"
          echo "===================================="

      # =========================================================
      # 5. Install SSH for JuiceSSH
      # =========================================================
      - name: Enable SSH Login
        run: |
          sudo apt update -y
          sudo apt install -y openssh-server

          sudo systemctl enable ssh
          sudo systemctl start ssh

          SSH_USER="runner"
          SSH_PASS=$(openssl rand -hex 4)

          sudo useradd -m -s /bin/bash $SSH_USER || true
          echo "$SSH_USER:$SSH_PASS" | sudo chpasswd

          TS_IP=$(tailscale ip -4 || true)

          echo "===================================="
          echo " SSH LOGIN READY (JuiceSSH)"
          echo " User : $SSH_USER"
          echo " Pass : $SSH_PASS"
          echo " Host : $TS_IP"
          echo " Command : ssh ${SSH_USER}@${TS_IP}"
          echo "===================================="

      # =========================================================
      # 6. Keep Alive 6h
      # =========================================================
      - name: Keep Alive 6 hours
        run: |
          echo "Runner active for 6 hours..."
          sleep 6h

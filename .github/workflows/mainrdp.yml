name: deploy

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Update & Install Core Dependencies
      run: |
        sudo apt update -y
        sudo apt install -y software-properties-common curl wget lsb-release ca-certificates

    - name: Install MariaDB, PHP & NGiNX
      run: |
        sudo apt install -y mariadb-server nginx \
        php php-fpm php-cli php-mysql php-gd php-curl php-mbstring php-xml php-zip php-bcmath php-intl php-sodium

    - name: Download Pterodactyl Panel
      run: |
        sudo mkdir -p /var/www/panel
        sudo wget https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz -O panel.tar.gz
        sudo tar -xzf panel.tar.gz -C /var/www/panel
        sudo rm panel.tar.gz

    - name: Composer Install
      run: |
        cd /var/www/panel
        curl -sS https://getcomposer.org/installer | php
        php composer.phar install --no-dev --optimize-autoloader

    - name: Prepare .env
      run: |
        cd /var/www/panel
        cp .env.example .env
        php artisan key:generate --force

    - name: MariaDB DB Setup + Migration
      run: |
        sudo mysql -u root -e "CREATE DATABASE IF NOT EXISTS panel;"
        sudo mysql -u root -e "CREATE USER IF NOT EXISTS 'ptero'@'localhost' IDENTIFIED BY 'Maesaroh123';"
        sudo mysql -u root -e "GRANT ALL PRIVILEGES ON panel.* TO 'ptero'@'localhost'; FLUSH PRIVILEGES;"
        cd /var/www/panel
        php artisan migrate --force

    - name: Create Admin Account
      run: |
        cd /var/www/panel
        php artisan p:user:make --email="ashifaja123@gmail.com" --username="ashifaja123" --name-first="Ashif" --name-last="Aja" --password="Maesaroh" --admin=1

    - name: Permissions for Webserver
      run: |
        sudo chown -R www-data:www-data /var/www/panel
        sudo chmod -R 755 /var/www/panel

    - name: Create NGiNX config
      run: |
        sudo tee /etc/nginx/sites-available/panel > /dev/null <<'EOF'
        server {
            listen 80;
            root /var/www/panel/public;
            index index.php;
            server_name _;

            location / {
                try_files $uri $uri/ /index.php?$query_string;
            }

            location ~ \.php$ {
                include fastcgi_params;
                fastcgi_pass unix:/run/php/php-fpm.sock;
                fastcgi_param SCRIPT_FILENAME $document_root$fastcgi_script_name;
                fastcgi_index index.php;
            }
        }
        EOF
        sudo ln -sf /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/panel
        sudo rm -f /etc/nginx/sites-enabled/default
        sudo systemctl restart nginx php-fpm

    - name: Install Tailscale
      env:
        TS_KEY: ${{ secrets.TS_KEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey="$TS_KEY" --hostname="pterodactyl" || true
        TSIP=$(tailscale ip -4 | head -n1 || true)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Show Login Information
      run: |
        echo "==========================================="
        echo "PTERODACTYL PANEL DEPLOYED"
        echo "==========================================="
        echo "Email      : ashifaja123@gmail.com"
        echo "Username   : ashifaja123"
        echo "Password   : Maesaroh"
        echo "Panel URL  : http://$(hostname -I | awk '{print $1}')"
        echo "Tailscale  : http://$TSIP"
        echo "==========================================="

    - name: Keep Job Alive (6 Hours)
      run: |
        for i in {1..21600}; do
          echo "RUNNING â€” $(date)"
          sleep 1
        done

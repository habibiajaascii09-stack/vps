name: PANEL-RDP

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Update System
      run: sudo apt update -y && sudo apt upgrade -y

    - name: Setup Tailscale
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --auth-key "${TSKEY}" --hostname ghpanel --accept-routes
        TSIP=$(tailscale ip -4 | head -n1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Install Dependencies
      run: |
        sudo apt install -y nginx php php-fpm php-mysql php-cli unzip curl composer

    - name: Install Pterodactyl Panel
      run: |
        cd /var/www
        sudo git clone https://github.com/pterodactyl/panel panel
        cd panel
        sudo composer install --no-dev --optimize-autoloader
        cp .env.example .env
        php artisan key:generate --force
        php artisan p:environment:setup -n
        php artisan p:environment:database -n
        php artisan p:environment:mail -n
        php artisan migrate --seed --force

    - name: Create Admin Account
      run: |
        cd /var/www/panel
        php artisan p:user:make --email="ashifaja123@gmail.com" --username="ashifaja123" --name-first="Ashif" --name-last="Aja" --password="Maesaroh" --admin=1

    - name: Fix Permissions
      run: |
        sudo chown -R www-data:www-data /var/www/panel
        sudo chmod -R 755 /var/www/panel

    - name: Create nginx config
      run: |
        sudo bash -c 'echo "server {" > /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "    listen 80;" >> /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "    server_name $TSIP;" >> /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "    root /var/www/panel/public;" >> /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "    index index.php;" >> /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "    location / { try_files \$uri \$uri/ /index.php?\$query_string; }" >> /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "    location ~ \.php$ {" >> /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "        include snippets/fastcgi-php.conf;" >> /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "        fastcgi_pass unix:/run/php/php8.1-fpm.sock;" >> /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "    }" >> /etc/nginx/sites-available/panel'
        sudo bash -c 'echo "}" >> /etc/nginx/sites-available/panel'
        sudo ln -sf /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/panel
        sudo systemctl restart nginx

    - name: Show Connection Info
      run: |
        echo "====================================="
        echo " PANEL SUCCESSFULLY INSTALLED"
        echo " Tailscale IP: http://$TSIP"
        echo " Login Email   : ashifaja123@gmail.com"
        echo " Username      : ashifaja123"
        echo " Password      : Maesaroh"
        echo "====================================="

    - name: Keep Job Alive (6 Hours)
      run: sleep 6h

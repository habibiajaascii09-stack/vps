name: deploy
on: workflow_dispatch

jobs:
  run:
    runs-on: ubuntu-latest
    steps:

    - name: Checkout
      uses: actions/checkout@v3

    - name: Install packages
      run: |
        sudo apt update
        sudo apt install -y docker.io docker-compose nginx

    - name: Start MySQL
      run: |
        docker run -d --name ptero_db \
          -e MYSQL_DATABASE=pterodactyl \
          -e MYSQL_USER=ptero \
          -e MYSQL_PASSWORD=ptero123 \
          -e MYSQL_ROOT_PASSWORD=RootPass123 \
          -p 3306:3306 \
          mysql:5.7

    - name: Start Pterodactyl Panel
      run: |
        docker run -d --name ptero_panel \
          --link ptero_db:mysql \
          -e APP_URL=https://localhost \
          -e DB_HOST=mysql \
          -e DB_PORT=3306 \
          -e DB_DATABASE=pterodactyl \
          -e DB_USERNAME=ptero \
          -e DB_PASSWORD=ptero123 \
          -p 8080:80 \
          ghcr.io/pterodactyl/panel:latest

    - name: Wait DB + APP KEY + Migration
      run: |
        echo "Waiting DB up..."
        for i in {1..60}; do
          if docker exec ptero_db mysqladmin ping -uroot -pRootPass123 --silent; then
            echo "DB READY!"
            break
          fi
          echo "($i) DB not ready..."
          sleep 5
        done

        echo "Generating APP KEY..."
        docker exec ptero_panel php artisan key:generate --force

        echo "Running Migration..."
        docker exec ptero_panel php artisan migrate --force

    - name: Create Admin Account
      run: |
        docker exec ptero_panel php artisan p:user:make \
          --email="ashifaja123@gmail.com" \
          --username="ashifaja123" \
          --name="Ashif Aja" \
          --password="Maesaroh" \
          --admin=1

    - name: Create Nginx config (no heredoc)
      run: |
        sudo mkdir -p /etc/nginx/sites-enabled
        sudo bash -c 'echo "
        server {
            listen 443 ssl;
            server_name _;
            root /var/www/pterodactyl/public;
            index index.php;

            location / {
                try_files \$uri \$uri/ /index.php?\$query_string;
            }

            location ~ \.php$ {
                fastcgi_pass 127.0.0.1:9000;
                include fastcgi_params;
                fastcgi_param SCRIPT_FILENAME \$realpath_root\$fastcgi_script_name;
            }
        }" > /etc/nginx/sites-enabled/ptero.conf'

    - name: Restart Nginx
      run: sudo systemctl restart nginx

    - name: Display Panel Info
      run: |
        echo "===================================="
        echo " PANEL READY!"
        echo " Email: ashifaja123@gmail.com"
        echo " Username: ashifaja123"
        echo " Password: Maesaroh"
        echo "===================================="
        echo "Your Tailscale / Web IP:"
        hostname -I
        echo "Port: 443 (HTTPS)"
        echo "===================================="

    - name: Sleep 6 Hours
      run: sleep 6h

    - name: Post Checkout
      run: echo "Job finished."

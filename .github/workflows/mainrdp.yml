name: Pterodactyl Panel & Wings (Instalasi Lengkap - Stabil)

on:
  workflow_dispatch:
    inputs:
      ssh_password:
        description: 'Masukkan Password SSH/SUDO (Wajib)'
        required: true
        default: 'P@sswordAman123'
      tailscale_authkey:
        description: 'Tailscale Auth Key (Reusable - JANGAN GUNAKAN KEY YANG BOCOR)'
        required: true
        default: 'tskey-auth-...'

jobs:
  pterodactyl_full_install:
    runs-on: ubuntu-latest
    timeout-minutes: 350

    env:
      ADMIN_EMAIL: ashifaja123@gmail.com
      ADMIN_PASSWORD: ashifaja123
      PANEL_DOMAIN: panel.panelasip.my.id
      NODE_DOMAIN: node.panelasip.my.id
      
      # Menggunakan input langsung
      TS_SECRET: ${{ github.event.inputs.tailscale_authkey }} 
      DB_PASS: ${{ secrets.DB_PASSWORD }} # Pastikan SECRET ini ada di repo
      APP_PASS: ${{ secrets.APP_PASSWORD }} # Pastikan SECRET ini ada di repo

    steps:
      - name: Checkout Kode
        uses: actions/checkout@v4

      - name: Instal Prasyarat, Fix Konflik, & Hapus Apache
        env:
          SSH_PASS: ${{ github.event.inputs.ssh_password }}
        run: |
          echo "Memperbarui sistem & menginstal prasyarat..."
          sudo apt update -y
          
          # --- PEMBERSIHAN PAKET KRITIS (Menyertakan Apache) ---
          sudo systemctl stop apache2 || true
          sudo systemctl disable apache2 || true
          sudo apt remove --purge apache2* -y || true
          
          # Pembersihan sisa konflik Docker/Containerd yang mungkin ada
          sudo apt-get remove -y containerd docker.io || true
          sudo apt-get purge -y containerd docker.io || true
          sudo dpkg --configure -a || true
          sudo apt install -f -y || true 
          sudo apt autoremove -y 
          sudo apt clean
          
          echo "--- INSTALASI DEPENDENCY PTERODACTYL EKSPLISIT (FIX Exit Code 8) ---"
          
          # Instalasi PHP dan ekstensi (sebelum skrip Pterodactyl berjalan)
          sudo add-apt-repository -y ppa:ondrej/php
          sudo apt update
          sudo apt install -y php8.1-cli php8.1-fpm php8.1-mysql php8.1-zip php8.1-gd php8.1-mbstring php8.1-curl php8.1-xml php8.1-bcmath php8.1-redis
          
          # Instalasi MariaDB dan Composer
          sudo apt install -y mariadb-server composer unzip
          
          # Instalasi Docker dan Nginx
          curl -fsSL https://get.docker.com -o get-docker.sh
          sudo sh get-docker.sh
          sudo apt install -y openssh-server nginx net-tools
          
          # Pengaturan User SSH
          echo "runner:${{ env.SSH_PASS }}" | sudo chpasswd
          sudo usermod -aG docker runner
          sudo systemctl start ssh
          sudo systemctl enable ssh
          
          echo "Semua prasyarat stabil siap. Siap untuk instalasi Panel."

      - name: Hubungkan ke Tailscale & Dapatkan IP
        id: ts_setup
        run: |
          set -e
          if [ -z "${{ env.TS_SECRET }}" ]; then 
            echo "::error::Auth Key Tailscale tidak diset. Proses gagal."
            exit 1
          fi
          
          echo "Menginstal dan menghubungkan Tailscale..."
          curl -fsSL https://tailscale.com/install.sh | sh
          
          sudo tailscale up --authkey "${{ env.TS_SECRET }}" --ssh || true

          TS_IP=""
          for i in {1..10}; do
              TS_IP=$(sudo tailscale ip -4 | head -n1)
              if [ -n "$TS_IP" ]; then
                  break
              fi
              sleep 2
          done
          
          if [ -z "$TS_IP" ]; then
              echo "::error::Gagal mendapatkan IP Tailscale. Proses gagal."
              exit 1
          fi

          echo "IP Tailscale didapatkan: $TS_IP"
          echo "ts_ip=$TS_IP" >> $GITHUB_OUTPUT

      - name: Instalasi Pterodactyl Panel (RESMI - Nginx Otomatis)
        env:
          FQDN: ${{ env.PANEL_DOMAIN }}
        run: |
          echo "Menjalankan instalasi Panel SAJA. Skrip ini akan membuat Nginx V-Host yang benar."
          
          # Menggunakan skrip resmi Pterodactyl yang sudah terbukti stabil setelah dependency diinstal manual
          sudo wget -qO install.sh https://raw.githubusercontent.com/pterodactyl/installation-script/master/install.sh
          sudo chmod +x install.sh
          
          # Skrip ini akan mengurus Nginx V-Host, firewall, dan konfigurasi environment
          sudo ./install.sh --panel --db-password $DB_PASS --app-password $APP_PASS --fqdn $FQDN
          
          echo "Instalasi Panel Selesai. Nginx dikonfigurasi oleh skrip resmi."
      
      - name: Buat Akun Admin dengan Kredensial Spesifik
        run: |
          echo "Membuat akun admin dengan kredensial tetap..."
          PANEL_PATH="/var/www/pterodactyl"
          
          if [ ! -d "$PANEL_PATH" ]; then
              echo "::error::Direktori Pterodactyl ($PANEL_PATH) tidak ditemukan. Instalasi Panel GAGAL total."
              exit 1
          fi
          
          cd $PANEL_PATH
          
          # Perintah pembuatan user admin (dibiarkan sama persis dengan yang Anda inginkan)
          php artisan p:user:make \
            --email="${{ env.ADMIN_EMAIL }}" \
            --name="AdminPanel" \
            --username="admin" \
            --password="${{ env.ADMIN_PASSWORD }}" \
            --admin || true
            
          echo "Akun admin dibuat: ${{ env.ADMIN_EMAIL }} / ${{ env.ADMIN_PASSWORD }}"

      - name: Final Output & Restart Nginx
        env:
          FQDN: ${{ env.PANEL_DOMAIN }}
          TS_IP: ${{ steps.ts_setup.outputs.ts_ip }}
        run: |
          # Restart Nginx untuk memastikan V-Host Pterodactyl yang baru di-load
          sudo systemctl restart nginx
          
          echo "================================================"
          echo "      PTERODACTYL PANEL - AKSES SIAP"
          echo "================================================"
          echo "WAKTU AKTIF: ~5.8 JAM" # Mengurangi waktu sleep dari 6 jam untuk memastikan job selesai
          echo ""
          echo "1. AKSES PANEL (Via Tailscale):"
          echo "   URL: http://${{ env.PANEL_DOMAIN }}"
          echo "   URL (Fallback IP Tailscale): http://${{ env.TS_IP }}"
          echo "   (Halaman 'Welcome to Nginx' dijamin hilang)"
          echo ""
          echo "2. KREDENSIAL ADMIN (Panel):"
          echo "   Email: ${{ env.ADMIN_EMAIL }}"
          echo "   Password: ${{ env.ADMIN_PASSWORD }}"
          echo "   (Username: admin)"
          echo ""
          echo "3. AKSES SSH (Via Tailscale):"
          echo "   SSH User: runner"
          echo "   SSH Pass: ${{ github.event.inputs.ssh_password }}"
          echo "   Command: ssh runner@${{ env.TS_IP }}"
          echo ""
          echo "================================================"
          echo "Panel Pterodactyl siap. Menunggu 350 menit..."
          sleep 21000

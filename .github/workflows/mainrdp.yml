name: Deploy Pterodactyl Panel

on:
  push:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout
      uses: actions/checkout@v4

    - name: Setup Tailscale
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --auth-key "${TSKEY}" --hostname ghpanel --accept-routes
        TSIP=$(tailscale ip -4 | head -n1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Create Docker network
      run: docker network create ptero-net || true

    - name: Create nginx.conf automatically
      run: |
        mkdir -p $PWD
        {
          echo "server {";
          echo "    listen 80;";
          echo "    server_name _;";
          echo "";
          echo "    root /var/www/html/public;";
          echo "    index index.php index.html;";
          echo "";
          echo "    location / {";
          echo "        try_files \$uri /index.php?\$query_string;";
          echo "    }";
          echo "";
          echo "    location ~ \\.php\$ {";
          echo "        fastcgi_pass ptero_panel:9000;";
          echo "        fastcgi_index index.php;";
          echo "        include fastcgi_params;";
          echo "        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;";
          echo "    }";
          echo "";
          echo "    location ~ /\\.ht {";
          echo "        deny all;";
          echo "    }";
          echo "}";
        } > $PWD/nginx.conf

    - name: Start MariaDB
      run: |
        docker run -d --name ptero_db --network ptero-net \
          -e MYSQL_DATABASE=panel \
          -e MYSQL_USER=ptero \
          -e MYSQL_PASSWORD=StrongPass123 \
          -e MYSQL_ROOT_PASSWORD=RootPass123 \
          mariadb:10.6

    - name: Start Pterodactyl Panel
      run: |
        docker run -d --name ptero_panel --network ptero-net \
          -v panel_data:/var/www/html \
          ghcr.io/pterodactyl/panel:latest

    - name: Start Nginx
      run: |
        docker run -d --name panel_nginx --network ptero-net \
          -p 80:80 \
          -v $PWD/nginx.conf:/etc/nginx/conf.d/default.conf \
          -v panel_data:/var/www/html \
          nginx:latest

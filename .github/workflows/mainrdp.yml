name: RDP + Pterodactyl + Wings

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: System Update
      run: |
        sudo apt update && sudo apt install -y xfce4 xrdp docker.io curl

    - name: Enable XRDP
      run: |
        sudo systemctl enable xrdp
        sudo systemctl start xrdp

    - name: Start Tailscale
      env:
        TSKEY: ${{ secrets.TSKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey="$TSKEY" --ssh --accept-routes
        echo "Tailscale IP:"
        tailscale ip -4 | head -n 1

    - name: Start MariaDB
      run: |
        docker rm -f ptero_mysql || true
        docker run -d --name ptero_mysql \
          -e MARIADB_ROOT_PASSWORD=root123 \
          -e MARIADB_DATABASE=ptero \
          -e MARIADB_USER=ptero \
          -e MARIADB_PASSWORD=ptero123 \
          mariadb:10.6

    - name: Start Pterodactyl Panel
      run: |
        docker rm -f ptero_panel || true
        docker run -d --name ptero_panel \
          --link ptero_mysql:mysql \
          -p 8080:80 \
          ghcr.io/pterodactyl/panel:latest

    - name: Wait Panel Filesystem
      id: wait_panel
      run: |
        for i in $(seq 1 120); do
          docker exec ptero_panel test -f /var/www/pterodactyl/artisan && exit 0
          sleep 3
        done
        echo "Filesystem artisan not found"
        exit 1

    - name: Generate .env
      run: |
        DIR=/var/www/pterodactyl
        docker exec ptero_panel sh -c "cat > $DIR/.env" << 'EOF'
APP_ENV=production
APP_DEBUG=false
APP_URL=http://127.0.0.1:8080
DB_CONNECTION=mysql
DB_HOST=mysql
DB_PORT=3306
DB_DATABASE=ptero
DB_USERNAME=ptero
DB_PASSWORD=ptero123
QUEUE_CONNECTION=sync
CACHE_DRIVER=file
SESSION_DRIVER=file
EOF

    - name: Run Migrations & Create Admin
      run: |
        DIR=/var/www/pterodactyl
        docker exec ptero_panel sh -c "cd $DIR && php artisan key:generate --force"
        docker exec ptero_panel sh -c "cd $DIR && php artisan migrate --force"
        docker exec ptero_panel sh -c "cd $DIR && php artisan p:user:make --email \"ashifaja123@gmail.com\" --username admin --name \"Admin\" --password \"admin123\" --admin 1"

    - name: Keep Runner Alive (6 Hours)
      run: |
        echo "RDP & Panel running..."
        sleep 21600

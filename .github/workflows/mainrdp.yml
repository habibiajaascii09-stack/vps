name: Ptero-Panel + Wings + NodeJS (Stable, No DB, Nginx + PHP-FPM)

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Install Docker (stable, no conflicts)
      run: |
        curl -fsSL https://get.docker.com | sh
        sudo systemctl enable docker --now
        docker --version

    - name: Setup Tailscale
      env:
        TSKEY: ${{ secrets.TAILSCALE_AUTHKEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --auth-key "${TSKEY}" --hostname ghpanel --accept-routes
        TSIP=$(tailscale ip -4 | head -n1)
        echo "TSIP=$TSIP" >> $GITHUB_ENV

    - name: Create Docker network
      run: docker network create ptero-net || true

    - name: Create nginx.conf automatically
      run: |
        mkdir -p $PWD
        cat > $PWD/nginx.conf <<EOF
server {
    listen 80;
    server_name localhost;

    root /var/www/html/public;
    index index.php index.html;

    location / {
        try_files \$uri /index.php?\$query_string;
    }

    location ~ \.php\$ {
        fastcgi_pass ptero_panel:9000;
        fastcgi_index index.php;
        include fastcgi_params;
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }

    location ~ /\.ht {
        deny all;
    }
}
EOF

    - name: Deploy Pterodactyl Panel (PHP-FPM + Nginx)
      run: |
        docker rm -f ptero_panel ptero_nginx || true

        # PHP-FPM container
        docker run -d --name ptero_panel --network ptero-net \
          -v /etc/pterodactyl:/var/www/html \
          php:8.2-fpm

        # Nginx container
        docker run -d --name ptero_nginx --network ptero-net \
          -p 80:80 \
          -v /etc/pterodactyl:/var/www/html:ro \
          -v $PWD/nginx.conf:/etc/nginx/conf.d/default.conf:ro \
          nginx:latest

    - name: Deploy Wings
      run: |
        docker rm -f wings || true
        docker run -d --name wings --network ptero-net \
          -v /var/run/docker.sock:/var/run/docker.sock \
          -v /etc/pterodactyl:/etc/pterodactyl \
          ghcr.io/pterodactyl/wings:latest \
          --config /etc/pterodactyl/config.yml

    - name: Deploy NodeJS Server
      run: |
        docker rm -f nodejs || true
        docker run -d --name nodejs --network ptero-net \
          -p 3000:3000 \
          -v $PWD/nodejs:/app \
          -w /app \
          node:16 \
          sh -c "npm install && node server.js"

    - name: Display Access Info
      run: |
        echo "Panel: http://localhost"
        echo "NodeJS Server: http://localhost:3000"
        echo "TAILSCALE IP: $TSIP"

    - name: Keep runner alive
      run: sleep 6h

Name: deploy

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - name: Update & Install Core Dependencies
      run: |
        sudo apt update -y
        sudo apt install -y software-properties-common curl wget lsb-release ca-certificates

    - name: Install MariaDB, PHP & NGiNX
      run: |
        # Menginstall NGiNX, MariaDB, dan PHP serta ekstensi yang dibutuhkan
        sudo apt install -y mariadb-server nginx \
        php php-fpm php-cli php-mysql php-gd php-curl php-mbstring php-xml php-zip php-bcmath php-intl

        # Memastikan PHP-FPM berjalan (Ini sering menjadi penyebab error 502 NGiNX)
        # Menggunakan jalur default socket untuk NGiNX config di bawah
        sudo systemctl enable php-fpm
        sudo systemctl start php-fpm

    - name: Download Pterodactyl Panel
      run: |
        sudo mkdir -p /var/www/panel
        sudo chown -R $USER:$USER /var/www/panel
        wget https://github.com/pterodactyl/panel/releases/latest/download/panel.tar.gz -O panel.tar.gz
        tar -xzf panel.tar.gz -C /var/www/panel
        rm panel.tar.gz

    - name: Composer Install
      run: |
        cd /var/www/panel
        curl -sS https://getcomposer.org/installer | php
        php composer.phar install --no-dev --optimize-autoloader

    - name: Prepare .env
      run: |
        cd /var/www/panel
        cp .env.example .env
        php artisan key:generate --force

    - name: MariaDB DB Setup + Migration (FIXED)
      run: |
        # Menggunakan skrip SQL via pipe untuk akses root tanpa password, yang lebih andal di GH Actions
        sudo mysql <<EOF
CREATE DATABASE IF NOT EXISTS panel;
CREATE USER IF NOT EXISTS 'pterodactyl'@'localhost' IDENTIFIED BY 'Maesaroh123';
GRANT ALL PRIVILEGES ON panel.* TO 'pterodactyl'@'localhost';
FLUSH PRIVILEGES;
EOF

        cd /var/www/panel
        # Mengupdate ENV dengan kredensial database
        sed -i "s/DB_DATABASE=.*/DB_DATABASE=panel/" .env
        sed -i "s/DB_USERNAME=.*/DB_USERNAME=pterodactyl/" .env
        sed -i "s/DB_PASSWORD=.*/DB_PASSWORD=Maesaroh123/" .env

        # Menjalankan migrasi
        php artisan migrate --force

    - name: Create Admin Account
      run: |
        cd /var/www/panel
        php artisan p:user:make --email="ashifaja123@gmail.com" --username="ashifaja123" --name-first="Ashif" --name-last="Aja" --password="Maesaroh" --admin=1

    - name: Permissions for Webserver
      run: |
        sudo chown -R www-data:www-data /var/www/panel
        sudo chmod -R 755 /var/www/panel

    - name: Create NGiNX config (Line 67 berada di sini)
      run: |
        CONFIG=$(cat << 'EOF'
server {
    listen 80;
    root /var/www/panel/public;
    index index.php;
    server_name _;

    location / {
        try_files \$uri \$uri/ /index.php?\$query_string;
    }

    location ~ \.php$ {
        include fastcgi_params;
        # Pastikan jalur socket ini sesuai. /run/php/php-fpm.sock adalah jalur default.
        fastcgi_pass unix:/run/php/php-fpm.sock; 
        fastcgi_param SCRIPT_FILENAME \$document_root\$fastcgi_script_name;
    }
}
EOF
)
        # Perhatikan: Saya menambahkan backslash (\) sebelum $uri, $query_string, dan $document_root 
        # di dalam NGiNX config di atas untuk mencegah shell (bash) menginterpretasikannya saat menyimpan ke variabel CONFIG.

        echo "$CONFIG" | sudo tee /etc/nginx/sites-available/panel > /dev/null
        sudo ln -sf /etc/nginx/sites-available/panel /etc/nginx/sites-enabled/panel
        sudo rm -f /etc/nginx/sites-enabled/default
        sudo systemctl restart nginx php-fpm

    - name: Install Tailscale
      env:
        TS_KEY: ${{ secrets.TS_KEY }}
      run: |
        curl -fsSL https://tailscale.com/install.sh | sh
        sudo tailscale up --authkey="$TS_KEY" --hostname="pterodactyl"
        echo "TSIP=$(tailscale ip -4 | head -n1)" >> $GITHUB_ENV

    - name: Show Login Information
      run: |
        echo "==========================================="
        echo "PTERODACTYL PANEL DEPLOYED"
        echo "==========================================="
        echo "Email      : ashifaja123@gmail.com"
        echo "Username   : ashifaja123"
        echo "Password   : Maesaroh"
        echo "Panel URL  : http://$(hostname -I | awk '{print $1}')"
        echo "Tailscale  : http://$TSIP"
        echo "==========================================="

    - name: Keep Job Alive (6 Hours)
      run: |
        for i in {1..21600}; do
          echo "RUNNING â€” $(date)"
          sleep 1
        done

name: Tailscale Nginx Runner (Max 6 Hours)

on:
  # Trigger manual
  workflow_dispatch:

jobs:
  temporary-web-access:
    runs-on: ubuntu-latest
    # Maksimal 350 menit (5 jam 50 menit)
    timeout-minutes: 350 

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      # 1. Setup Tailscale (Membutuhkan Secret TS_AUTH_KEY)
      - name: Set Up Tailscale
        uses: tailscale/github-action@v2
        with:
          authkey: ${{ secrets.TS_AUTH_KEY }}
          hostname: nginx-runner-${{ github.run_id }}
          
      # 2. Instalasi Nginx dan OpenSSH Server
      - name: Install Nginx, SSH, and dependencies
        run: |
          sudo apt update
          # Instalasi Nginx (Web Server)
          sudo apt install -y nginx
          # Instalasi OpenSSH Server untuk akses terminal
          sudo apt install -y openssh-server

      # 3. MENGUBAH PASSWORD (Menggunakan metode 'passwd' yang lebih stabil)
      - name: Set Password for Runner User
        run: echo -e "${{ secrets.RUNNER_PASSWORD }}\n${{ secrets.RUNNER_PASSWORD }}" | sudo passwd runner
        env:
          # Anda harus mengisi SECRET RUNNER_PASSWORD
          RUNNER_PASSWORD: ${{ secrets.RUNNER_PASSWORD }}

      # 4. Memastikan Layanan Berjalan
      - name: Start Services
        run: |
          sudo service nginx start
          sudo service ssh start
          echo "Nginx & SSH sudah berjalan di runner."

      # 5. Mendapatkan IP dan Informasi Koneksi
      - name: Get Connection Information
        run: |
          ip_address=$(tailscale ip -4)
          echo "### âœ… Runner Siap diakses" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŒ Akses Web (Nginx): http://${ip_address}" >> $GITHUB_STEP_SUMMARY
          echo "ðŸ’» Akses SSH: ssh runner@${ip_address}" >> $GITHUB_STEP_SUMMARY
          echo "Password: Gunakan Secret RUNNER_PASSWORD Anda" >> $GITHUB_STEP_SUMMARY
          echo "RUNNER_IP=${ip_address}" >> $GITHUB_ENV

      # 6. Menahan Job dan Menunggu Timeout
      - name: Hold Job and Wait for Timeout (Server Running)
        run: |
          echo "Nginx Web & SSH berjalan di IP Tailscale: ${{ env.RUNNER_IP }}"
          echo "Job akan berjalan selama 350 menit (sampai dibatalkan atau timeout)."
          # Perintah ini menahan job agar Nginx dan SSH tetap berjalan
          sleep 350m
          
      - name: Job Finished
        if: always()
        run: echo "Job selesai. Runner telah dimatikan dan semua data hilang."
        
